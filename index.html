<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Baseball Scorer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #f1f5f9;
      color: #111827;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      max-width: 480px;
      margin: 0 auto;
      padding: 12px 12px calc(158px + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
      padding: 16px;
    }

    /* ‚îÄ‚îÄ GAME STATE BAR ‚îÄ‚îÄ */
    .game-state-bar {
      position: sticky;
      top: 12px;
      z-index: 50;
      background: #1f2937;
      border-radius: 14px;
      padding: 10px 14px 9px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .gsb-top {
      display: flex;
      align-items: center;
      gap: 7px;
      flex-wrap: wrap;
    }

    .gsb-piece {
      font-size: 0.72rem;
      font-weight: 700;
      color: #f9fafb;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .gsb-piece.gsb-danger { color: #fca5a5; }

    .gsb-sep {
      font-size: 0.65rem;
      color: #4b5563;
      font-weight: 400;
      flex-shrink: 0;
    }

    .gsb-batter {
      font-size: 0.7rem;
      font-weight: 600;
      color: #d1d5db;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    /* ‚îÄ‚îÄ HEADER CARD ‚îÄ‚îÄ */
    .score-header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }

    .team-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .team-input {
      background: transparent;
      border: none;
      border-bottom: 1.5px solid #e5e7eb;
      color: #374151;
      font-size: 0.78rem;
      font-family: inherit;
      font-weight: 700;
      text-transform: uppercase;
      text-align: center;
      padding: 2px 4px;
      width: 100%;
      letter-spacing: 0.8px;
      transition: border-color 0.2s;
    }

    .team-input:focus {
      outline: none;
      border-bottom-color: #dc2626;
    }

    .team-run-score {
      font-size: 2.6rem;
      font-weight: 800;
      color: #111827;
      line-height: 1;
    }

    .score-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding-top: 18px;
    }

    .score-dash {
      font-size: 1.4rem;
      color: #d1d5db;
      font-weight: 300;
    }

    /* ‚îÄ‚îÄ INNING BADGE ‚îÄ‚îÄ */
    .inning-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .half-arrows {
      display: flex;
      flex-direction: column;
      gap: 3px;
      align-items: center;
    }

    .arrow-up {
      width: 0; height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 8px solid #e5e7eb;
    }
    .arrow-up.active  { border-bottom-color: #dc2626; }

    .arrow-down {
      width: 0; height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid #e5e7eb;
    }
    .arrow-down.active { border-top-color: #dc2626; }

    .inning-text {
      font-size: 0.75rem;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ‚îÄ‚îÄ SCOREBOARD ‚îÄ‚îÄ */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th, td {
      padding: 5px 3px;
      text-align: center;
      min-width: 22px;
    }

    thead th {
      color: #9ca3af;
      font-weight: 500;
      padding-bottom: 6px;
      border-bottom: 1px solid #f3f4f6;
    }

    tbody tr + tr { border-top: 1px solid #f9fafb; }

    .team-cell {
      text-align: left !important;
      padding-left: 2px !important;
      font-weight: 700;
      color: #374151;
      white-space: nowrap;
      font-size: 0.75rem;
      min-width: 48px;
    }

    .batting { color: #dc2626 !important; }

    .active-cell {
      background: #fef2f2;
      color: #dc2626;
      font-weight: 700;
      border-radius: 4px;
    }

    .runs-col {
      font-weight: 800 !important;
      color: #111827 !important;
      font-size: 0.85rem;
      border-left: 1px solid #f3f4f6;
    }

    /* ‚îÄ‚îÄ FIELD CARD: diamond + count side by side ‚îÄ‚îÄ */
    .field-card {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      align-items: center;
    }

    .diamond-wrap {
      display: flex;
      justify-content: center;
    }

    /* ‚îÄ‚îÄ COUNT + PITCH ‚îÄ‚îÄ */
    .count-section {
      display: flex;
      flex-direction: column;
      gap: 9px;
    }

    .count-row-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .count-label {
      font-size: 0.65rem;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      min-width: 48px;
    }

    .dots { display: flex; gap: 6px; }

    .dot {
      width: 13px;
      height: 13px;
      border-radius: 50%;
      border: 2px solid;
    }

    .dot-ball            { border-color: #bbf7d0; }
    .dot-ball.lit        { background: #16a34a; border-color: #16a34a; }
    .dot-strike          { border-color: #fecaca; }
    .dot-strike.lit      { background: #dc2626; border-color: #dc2626; }
    .dot-out             { border-color: #fecaca; }
    .dot-out.lit         { background: #dc2626; border-color: #dc2626; }

    .count-divider {
      border: none;
      border-top: 1px solid #f3f4f6;
      margin: 2px 0;
    }

    .pitch-row-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pitch-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #pitchCount {
      font-size: 1.3rem;
      font-weight: 800;
      color: #111827;
      min-width: 2.2ch;
      text-align: center;
    }

    .pitch-adj {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      color: #6b7280;
      font-size: 1rem;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-family: inherit;
      line-height: 1;
    }

    .pitch-adj:active { background: #f3f4f6; }

    /* ‚îÄ‚îÄ ACTION BUTTONS ‚îÄ‚îÄ */
    .actions {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      padding: 10px 12px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
      background: #f1f5f9;
      z-index: 40;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      box-shadow: 0 -2px 16px rgba(0,0,0,0.10);
    }

    .btn {
      padding: 19px 10px;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 700;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      color: #fff;
    }

    .btn:active { filter: brightness(0.88); }

    .btn-ball   { background: #16a34a; }
    .btn-strike { background: #dc2626; }
    .btn-out    { background: #7c3aed; }
    .btn-run    { background: #2563eb; }
    .btn-hit    { background: #f59e0b; }

    /* ‚îÄ‚îÄ SECONDARY ‚îÄ‚îÄ */
    .secondary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .btn-sm {
      padding: 11px 4px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.72rem;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
    }

    .btn-sm:active { background: #f9fafb; }

    /* ‚îÄ‚îÄ BOTTOM ROW ‚îÄ‚îÄ */
    .bottom-row {
      display: flex;
      gap: 8px;
    }

    .btn-save-game {
      flex: 1;
      padding: 12px;
      background: #fff;
      border: 1.5px solid #16a34a;
      border-radius: 10px;
      color: #16a34a;
      font-family: inherit;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-save-game:active { background: #f0fdf4; }

    .btn-new-game {
      flex: 1;
      padding: 12px;
      background: #fff;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      color: #9ca3af;
      font-family: inherit;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-new-game:active { background: #f9fafb; }

    .btn-changes {
      flex: 1;
      padding: 11px 12px;
      background: #fff;
      border: 1.5px solid #3b82f6;
      border-radius: 10px;
      color: #3b82f6;
      font-family: inherit;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-changes:active { background: #eff6ff; }

    /* ‚îÄ‚îÄ CHANGES PANEL ‚îÄ‚îÄ */
    .changes-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.45);
      z-index: 100;
    }

    .changes-sheet {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      max-width: 480px;
      margin: 0 auto;
      background: #f1f5f9;
      border-radius: 20px 20px 0 0;
      max-height: 88vh;
      overflow-y: auto;
      z-index: 101;
      padding-bottom: 32px;
    }

    .changes-header {
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      border-radius: 20px 20px 0 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 16px 14px;
    }

    .changes-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: #111827;
    }

    .changes-done-btn {
      background: #111827;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 16px;
      font-family: inherit;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
    }

    .changes-team-label {
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.9px;
      color: #6b7280;
      padding: 12px 16px 4px;
    }

    .changes-player-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 16px;
      background: #fff;
      border-bottom: 1px solid #f3f4f6;
    }

    .changes-order {
      font-size: 0.72rem;
      color: #9ca3af;
      min-width: 16px;
      text-align: right;
    }

    .changes-name {
      flex: 1;
      font-size: 0.85rem;
      color: #111827;
      font-weight: 500;
    }

    .changes-sub-btn {
      font-size: 0.73rem;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 5px 10px;
      color: #374151;
      cursor: pointer;
      white-space: nowrap;
    }

    .changes-sub-btn:active { background: #e5e7eb; }

    .changes-pos-btn {
      font-size: 0.72rem;
      font-weight: 700;
      background: #f3f4f6;
      border: 1.5px solid #d1d5db;
      border-radius: 7px;
      padding: 5px 8px;
      color: #374151;
      cursor: pointer;
      min-width: 46px;
      text-align: center;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .changes-pos-btn:active { background: #e5e7eb; }

    .changes-sub-form {
      padding: 8px 16px 10px 40px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .changes-sub-input {
      flex: 1;
      min-width: 110px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 7px 10px;
      font-family: inherit;
      font-size: 0.85rem;
      background: #fff;
    }

    .changes-confirm-btn {
      background: #16a34a;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 7px 14px;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
    }

    .changes-cancel-btn {
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 7px;
      padding: 7px 10px;
      font-family: inherit;
      font-size: 0.8rem;
      color: #9ca3af;
      cursor: pointer;
    }

    /* ‚îÄ‚îÄ SECTION DIVIDER ‚îÄ‚îÄ */
    .section-divider {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 2px;
    }

    .section-divider::before,
    .section-divider::after {
      content: '';
      flex: 1;
      border-top: 1px solid #e5e7eb;
    }

    .section-divider span {
      font-size: 0.6rem;
      font-weight: 700;
      color: #d1d5db;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
    .history-header {
      display: flex;
      gap: 6px;
    }

    .history-toggle-btn {
      flex: 1;
      padding: 11px 12px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      text-align: left;
    }

    .history-toggle-btn:active { background: #f9fafb; }

    .btn-transfer {
      padding: 11px 12px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-transfer:active { background: #f9fafb; }

    #historyList {
      display: none;
      flex-direction: column;
      gap: 6px;
      padding-bottom: 12px;
    }

    .history-entry {
      display: flex;
      flex-direction: column;
      background: #fff;
      border: 1px solid #f3f4f6;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      overflow: hidden;
    }

    .history-entry-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      cursor: pointer;
    }

    .history-entry-header:active { background: #f9fafb; }

    .history-expand {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 0.75rem;
      padding: 2px 4px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .history-stats {
      border-top: 1px solid #f3f4f6;
      padding: 12px 14px;
      flex-direction: column;
      gap: 14px;
    }

    .history-date {
      font-size: 0.68rem;
      color: #9ca3af;
      white-space: nowrap;
      min-width: 64px;
    }

    .history-score {
      flex: 1;
      font-size: 0.88rem;
      color: #374151;
      text-align: center;
      font-weight: 500;
    }

    .history-score .winner {
      color: #dc2626;
      font-weight: 700;
    }

    .history-score .sep { color: #d1d5db; margin: 0 5px; }

    .history-delete {
      background: transparent;
      border: none;
      color: #d1d5db;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 2px 4px;
    }

    .history-delete:active { color: #9ca3af; }

    .history-empty {
      text-align: center;
      color: #9ca3af;
      font-size: 0.85rem;
      padding: 16px;
      background: #fff;
      border: 1px solid #f3f4f6;
      border-radius: 12px;
    }

    /* ‚îÄ‚îÄ ACTION SHEET ‚îÄ‚îÄ */
    #actionSheet {
      position: fixed;
      inset: 0;
      z-index: 200;
      display: none;
    }

    .as-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.35);
    }

    .as-panel {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      background: #fff;
      border-radius: 20px 20px 0 0;
      padding: 20px 16px 40px;
    }

    .as-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: #9ca3af;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 14px;
    }

    .as-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .as-btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      text-align: center;
    }

    .as-btn:active { filter: brightness(0.92); }
    .as-btn-advance { background: #eff6ff; color: #2563eb; }
    .as-btn-score   { background: #f0fdf4; color: #16a34a; }
    .as-btn-out     { background: #fef2f2; color: #dc2626; }
    .as-btn-hit     { background: #fffbeb; color: #d97706; }
    .as-btn-hr      { background: #fdf4ff; color: #9333ea; }
    .as-btn-cancel  { background: #f9fafb; color: #9ca3af; margin-top: 4px; }

    /* ‚îÄ‚îÄ BATTER CARD ‚îÄ‚îÄ */
    .batter-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .batter-info {
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .batter-label {
      font-size: 0.58rem;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }

    .batter-main-line {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 5px;
    }

    .batter-order-num {
      font-size: 0.78rem;
      font-weight: 600;
      color: #9ca3af;
    }

    .batter-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: #111827;
    }

    .batter-pos-badge {
      font-size: 0.7rem;
      font-weight: 600;
      color: #6b7280;
      background: #f3f4f6;
      padding: 1px 5px;
      border-radius: 4px;
    }

    .batter-stats-line {
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .batter-nav {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      color: #9ca3af;
      font-size: 0.75rem;
      width: 34px;
      height: 34px;
      cursor: pointer;
      font-family: inherit;
      flex-shrink: 0;
      line-height: 1;
    }

    .batter-nav:active { background: #f3f4f6; }

    /* ‚îÄ‚îÄ LINEUP STATS ‚îÄ‚îÄ */
    .lineup-stats-team {
      font-size: 0.7rem;
      font-weight: 700;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 8px;
    }

    .lineup-stats-table {
      width: 100%;
      font-size: 0.76rem;
      border-collapse: collapse;
    }

    .lineup-stats-table th {
      color: #9ca3af;
      font-weight: 500;
      text-align: center;
      padding: 4px 3px 6px;
      border-bottom: 1px solid #f3f4f6;
    }

    .lineup-stats-table th.lss-name,
    .lineup-stats-table td.lss-name {
      text-align: left;
      padding-left: 2px;
    }

    .lineup-stats-table td {
      text-align: center;
      padding: 5px 3px;
    }

    .lineup-stats-table tr + tr { border-top: 1px solid #f9fafb; }

    .lss-current td {
      color: #dc2626;
      font-weight: 700;
    }

    .pitching-header {
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #6b7280;
      margin-top: 12px;
      margin-bottom: 6px;
      padding-top: 10px;
      border-top: 1px solid #f3f4f6;
    }

    /* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
    #mainScreen {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #setupScreen {
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    .setup-title {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 800;
      color: #111827;
      padding: 8px 0 2px;
      letter-spacing: -0.3px;
    }

    .setup-subtitle {
      text-align: center;
      font-size: 0.76rem;
      color: #9ca3af;
      margin-top: 2px;
    }

    .setup-section-label {
      font-size: 0.68rem;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 8px;
    }

    .setup-team-input {
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.95rem;
      font-family: inherit;
      font-weight: 600;
      color: #111827;
      background: #f9fafb;
      outline: none;
      width: 100%;
      transition: border-color 0.15s;
    }

    .setup-team-input:focus {
      border-color: #dc2626;
      background: #fff;
    }

    .btn-start-game {
      width: 100%;
      padding: 18px;
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 14px;
      font-size: 1rem;
      font-weight: 700;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    }

    .btn-start-game:active { filter: brightness(0.88); }

    .btn-continue-game {
      width: 100%;
      padding: 13px;
      background: #fff;
      border: 1.5px solid #e5e7eb;
      border-radius: 12px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-continue-game:active { background: #f9fafb; }

    /* ‚îÄ‚îÄ PLAYER LIST ‚îÄ‚îÄ */
    .setup-lineup-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0 6px;
    }

    .btn-add-player {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 500;
      padding: 5px 10px;
      cursor: pointer;
    }

    .btn-add-player:active { background: #f3f4f6; }

    .player-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .player-list-empty {
      text-align: center;
      color: #9ca3af;
      font-size: 0.8rem;
      padding: 8px 0 2px;
    }

    .player-row {
      display: flex;
      align-items: center;
      gap: 7px;
      background: #f9fafb;
      border: 1px solid #f3f4f6;
      border-radius: 10px;
      padding: 8px 10px;
    }

    .player-num {
      font-size: 0.72rem;
      color: #9ca3af;
      min-width: 14px;
      text-align: right;
      flex-shrink: 0;
    }

    .player-name-input {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      font-family: inherit;
      font-size: 0.88rem;
      font-weight: 500;
      color: #111827;
      min-width: 0;
    }

    .player-pos-select {
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #fff;
      color: #374151;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 5px;
      cursor: pointer;
      outline: none;
      flex-shrink: 0;
    }

    .player-remove {
      background: transparent;
      border: none;
      color: #d1d5db;
      font-size: 1rem;
      cursor: pointer;
      padding: 0 2px;
      line-height: 1;
      flex-shrink: 0;
    }

    .player-remove:active { color: #9ca3af; }

    .drag-handle {
      color: #d1d5db;
      font-size: 1.1rem;
      cursor: grab;
      padding: 0 2px;
      line-height: 1;
      flex-shrink: 0;
      touch-action: none;
      user-select: none;
    }

    .drag-handle:active { cursor: grabbing; }

    .player-row.is-dragging { opacity: 0.25; }

    .player-row.drop-above { border-top: 2px solid #dc2626; }

    .drag-mirror {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.9;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      padding: 8px 10px;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.88rem;
      z-index: 999;
      display: none;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<div id="toast"></div>

<!-- Pre-game setup screen -->
<div id="setupScreen">
  <div>
    <div class="setup-title">‚öæ Baseball Scorer</div>
    <div class="setup-subtitle">Set up your game</div>
  </div>

  <div class="card">
    <div class="setup-section-label">Away Team</div>
    <input class="setup-team-input" id="setupAwayInput" value="Away" maxlength="10"
           autocomplete="off" autocorrect="off" spellcheck="false" placeholder="Away team name">
    <div class="setup-lineup-bar">
      <span class="setup-section-label" style="margin-bottom:0">Lineup</span>
      <button class="btn-add-player" onclick="addPlayer('away')">+ Add Player</button>
    </div>
    <div class="player-list" id="lineup-away"></div>
  </div>

  <div class="card">
    <div class="setup-section-label">Home Team</div>
    <input class="setup-team-input" id="setupHomeInput" value="Home" maxlength="10"
           autocomplete="off" autocorrect="off" spellcheck="false" placeholder="Home team name">
    <div class="setup-lineup-bar">
      <span class="setup-section-label" style="margin-bottom:0">Lineup</span>
      <button class="btn-add-player" onclick="addPlayer('home')">+ Add Player</button>
    </div>
    <div class="player-list" id="lineup-home"></div>
  </div>

  <button class="btn-start-game" onclick="startGame()">‚öæ Play Ball</button>
  <button class="btn-continue-game" id="continueBtn" onclick="hideSetup()">‚Üê Continue Current Game</button>
</div>

<!-- Main scoring screen -->
<div id="mainScreen">

<!-- Game State Bar -->
<div id="gameStateBar" class="game-state-bar">
  <div class="gsb-top">
    <span class="gsb-piece" id="gsbInning"></span>
    <span class="gsb-sep">|</span>
    <span class="gsb-piece" id="gsbOuts"></span>
    <span class="gsb-sep">|</span>
    <span class="gsb-piece" id="gsbCount"></span>
    <span class="gsb-sep">|</span>
    <span class="gsb-piece" id="gsbRunners"></span>
  </div>
  <div class="gsb-batter" id="gsbBatter"></div>
</div>

<!-- Header card: live score + team names + inning -->
<div class="card">
  <div class="score-header">
    <div class="team-block">
      <input class="team-input" id="awayInput" value="Away" maxlength="10"
             autocomplete="off" autocorrect="off" spellcheck="false" placeholder="AWAY">
      <div class="team-run-score" id="awayScore">0</div>
    </div>
    <div class="score-center">
      <span class="score-dash">‚Äî</span>
    </div>
    <div class="team-block">
      <input class="team-input" id="homeInput" value="Home" maxlength="10"
             autocomplete="off" autocorrect="off" spellcheck="false" placeholder="HOME">
      <div class="team-run-score" id="homeScore">0</div>
    </div>
  </div>
  <div class="inning-badge">
    <div class="half-arrows">
      <div class="arrow-up"   id="arrowUp"></div>
      <div class="arrow-down" id="arrowDown"></div>
    </div>
    <div class="inning-text" id="inningText">TOP ‚Äî 1st INNING</div>
  </div>
</div>

<!-- Scoreboard -->
<div class="card" style="padding: 12px 14px;">
  <table id="scoreboard"></table>
</div>

<!-- Field card: diamond + count + pitch -->
<div class="card">
  <div class="field-card">
    <div class="diamond-wrap">
      <svg width="138" height="138" viewBox="0 0 200 200">
        <!-- Dirt -->
        <polygon points="100,18 182,100 100,182 18,100"
                 fill="#fef9ef" stroke="#e8dcc8" stroke-width="1"/>
        <!-- Grass -->
        <polygon points="100,34 166,100 100,166 34,100"
                 fill="#f0f7e8" stroke="none"/>
        <!-- Base paths -->
        <line x1="100" y1="182" x2="182" y2="100" stroke="#ddd0b0" stroke-width="1.5"/>
        <line x1="182" y1="100" x2="100" y2="18"  stroke="#ddd0b0" stroke-width="1.5"/>
        <line x1="100" y1="18"  x2="18"  y2="100" stroke="#ddd0b0" stroke-width="1.5"/>
        <line x1="18"  y1="100" x2="100" y2="182" stroke="#ddd0b0" stroke-width="1.5"/>
        <!-- Home plate -->
        <polygon points="100,190 109,181 109,175 91,175 91,181" fill="#9ca3af"/>
        <!-- 2nd base -->
        <rect id="base2" x="87" y="7" width="26" height="22" rx="3"
              fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"
              style="cursor:pointer" onclick="clickBase(1)"/>
        <text id="baseLabel2" x="100" y="21" fill="#6b7280" font-size="11"
              text-anchor="middle" dominant-baseline="middle" pointer-events="none">2</text>
        <!-- 1st base -->
        <rect id="base1" x="163" y="88" width="26" height="24" rx="3"
              fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"
              style="cursor:pointer" onclick="clickBase(0)"/>
        <text id="baseLabel1" x="176" y="101" fill="#6b7280" font-size="11"
              text-anchor="middle" dominant-baseline="middle" pointer-events="none">1</text>
        <!-- 3rd base -->
        <rect id="base3" x="11" y="88" width="26" height="24" rx="3"
              fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"
              style="cursor:pointer" onclick="clickBase(2)"/>
        <text id="baseLabel3" x="24" y="101" fill="#6b7280" font-size="11"
              text-anchor="middle" dominant-baseline="middle" pointer-events="none">3</text>
      </svg>
    </div>

    <div class="count-section">
      <div class="count-row-item">
        <span class="count-label">Balls</span>
        <div class="dots" id="ballDots"></div>
      </div>
      <div class="count-row-item">
        <span class="count-label">Strikes</span>
        <div class="dots" id="strikeDots"></div>
      </div>
      <div class="count-row-item">
        <span class="count-label">Outs</span>
        <div class="dots" id="outDots"></div>
      </div>
      <hr class="count-divider">
      <div class="pitch-row-inner">
        <span class="count-label">Pitches</span>
        <div class="pitch-controls">
          <button class="pitch-adj" onclick="adjustPitches(-1)">‚àí</button>
          <span id="pitchCount">0</span>
          <button class="pitch-adj" onclick="adjustPitches(1)">+</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Current batter -->
<div class="card" id="batterCard" style="display:none; padding:12px 16px;">
  <div class="batter-row">
    <button class="batter-nav" onclick="manualPrevBatter()">‚óÄ</button>
    <div class="batter-info">
      <span class="batter-label">At Bat</span>
      <div class="batter-main-line">
        <span class="batter-order-num" id="batterOrderNum"></span>
        <span class="batter-name" id="batterName"></span>
        <span class="batter-pos-badge" id="batterPosBadge"></span>
      </div>
      <span class="batter-stats-line" id="batterStats"></span>
    </div>
    <button class="batter-nav" onclick="manualNextBatter()">‚ñ∂</button>
  </div>
</div>

<!-- Main action buttons -->
<div class="actions">
  <button class="btn btn-ball"   onclick="doBall()">Ball</button>
  <button class="btn btn-strike" onclick="doStrike()">Strike</button>
  <button class="btn btn-out"    onclick="doOut()">Out</button>
  <button class="btn btn-hit"    onclick="doHit()">Hit</button>
</div>

<!-- Secondary controls -->
<div class="secondary">
  <button class="btn-sm" onclick="doRun()">+ Run</button>
  <button class="btn-sm" onclick="undoRun()">‚àí Run</button>
  <button class="btn-sm" onclick="resetCount()">Reset Count</button>
  <button class="btn-sm" onclick="nextHalf()">Next Half ‚ñ∂</button>
</div>

<!-- Lineup Stats + Changes -->
<div class="history-header">
  <button class="history-toggle-btn" id="lineupStatsToggle" onclick="toggleLineupStats()">Lineup Stats ‚ñº</button>
  <button class="btn-transfer" onclick="openChanges()">Changes ‚Üï</button>
  <button class="btn-transfer" onclick="shareStats()">Share ‚Üó</button>
</div>
<div id="lineupStatsList" style="display:none; flex-direction:column; gap:6px;"></div>

<div class="section-divider"><span>Game Controls</span></div>

<!-- End / New game -->
<div class="bottom-row">
  <button class="btn-save-game" onclick="doSaveGame()">End Game</button>
  <button class="btn-new-game"  onclick="newGame()">New Game</button>
</div>

<!-- History -->
<div class="history-header">
  <button class="history-toggle-btn" id="historyToggle" onclick="toggleHistory()">Past Games ‚ñº</button>
  <button class="btn-transfer" onclick="exportHistory()">Export ‚Üì</button>
  <button class="btn-transfer" onclick="importHistory()">Import ‚Üë</button>
</div>
<div id="historyList"></div>

</div><!-- /mainScreen -->

<!-- Action sheet (base runner actions + hit type picker) -->
<div id="actionSheet">
  <div class="as-overlay" onclick="closeActionSheet()"></div>
  <div class="as-panel">
    <div class="as-title" id="asTitle"></div>
    <div class="as-buttons" id="asButtons"></div>
  </div>
</div>

<!-- Lineup Changes panel -->
<div class="changes-overlay" id="changesOverlay" onclick="closeChanges()" style="display:none"></div>
<div class="changes-sheet" id="changesSheet" style="display:none">
  <div class="changes-header">
    <span class="changes-title">Lineup Changes</span>
    <button class="changes-done-btn" onclick="closeChanges()">Done</button>
  </div>
  <div id="changesList"></div>
</div>

<script>
  // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let state = freshState();

  function freshState() {
    return {
      inning:    1,
      isTop:     true,
      balls:     0,
      strikes:   0,
      outs:      0,
      bases:     [null, null, null],
      pitches:   0,
      scorecard: Array.from({length: 9}, () => ({away: null, home: null})),
      lineup:     { away: [], home: [] },
      batterIdx:  { away: 0, home: 0 },
      lastBatter: { away: null, home: null }
    };
  }

  // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function ordinal(n) {
    const s = ['th','st','nd','rd'];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
  }

  function teamNames() {
    return {
      away: document.getElementById('awayInput').value.trim() || 'Away',
      home: document.getElementById('homeInput').value.trim() || 'Home'
    };
  }

  function battingTeam() {
    return state.isTop ? 'away' : 'home';
  }

  function ensureInning(idx) {
    while (state.scorecard.length <= idx) {
      state.scorecard.push({away: null, home: null});
    }
  }

  function totalRuns(team) {
    return state.scorecard.reduce((sum, inn) => sum + (inn[team] || 0), 0);
  }

  // ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let toastTimer = null;

  function showToast(msg, ms = 1800) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.display = 'block';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { el.style.display = 'none'; }, ms);
  }

  // ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function render() {
    saveCurrentGame();
    const n = teamNames();

    // Live score
    document.getElementById('awayScore').textContent = totalRuns('away');
    document.getElementById('homeScore').textContent = totalRuns('home');

    // Inning text + arrows
    document.getElementById('inningText').textContent =
      `${state.isTop ? 'TOP' : 'BOT'} ‚Äî ${ordinal(state.inning)} INNING`;
    document.getElementById('arrowUp').className =
      'arrow-up'   + (state.isTop ? ' active' : '');
    document.getElementById('arrowDown').className =
      'arrow-down' + (state.isTop ? '' : ' active');

    // Scoreboard
    renderScoreboard(n);

    // Bases
    renderBases();

    // Pitch count
    document.getElementById('pitchCount').textContent = state.pitches;

    // Count dots
    makeDots('ballDots',   state.balls,   3, 'ball');
    makeDots('strikeDots', state.strikes, 2, 'strike');
    makeDots('outDots',    state.outs,    2, 'out');

    // Current batter
    renderBatterCard();

    // Game state bar
    renderGameStateBar();

    // Refresh lineup stats if open
    if (lineupStatsOpen) renderLineupStats();
  }

  function renderGameStateBar() {
    // Inning
    const half = state.isTop ? '‚ñ≤' : '‚ñº';
    document.getElementById('gsbInning').textContent = `${half} ${ordinal(state.inning)}`;

    // Outs ‚Äî red when danger (2 outs)
    const outsEl = document.getElementById('gsbOuts');
    outsEl.textContent = state.outs === 1 ? '1 OUT' : `${state.outs} OUTS`;
    outsEl.className   = 'gsb-piece' + (state.outs === 2 ? ' gsb-danger' : '');

    // Count
    document.getElementById('gsbCount').textContent = `${state.balls}‚Äì${state.strikes}`;

    // Runners
    const names    = ['1B', '2B', '3B'];
    const occupied = names.filter((_, i) => state.bases[i]);
    let runnersText;
    if (occupied.length === 0)      runnersText = 'NONE ON';
    else if (occupied.length === 3) runnersText = 'LOADED';
    else                            runnersText = occupied.join(' & ');
    document.getElementById('gsbRunners').textContent = runnersText;

    // Batter
    const batterEl = document.getElementById('gsbBatter');
    const team   = battingTeam();
    const lineup = state.lineup[team];
    const p      = currentBatterPlayer();
    if (p && lineup && lineup.length > 0) {
      const idx  = state.batterIdx[team];
      const name = (p.name || `Player ${idx + 1}`).toUpperCase();
      const ab   = p.ab || 0;
      const h    = p.h  || 0;
      const avg  = ab ? '.' + String(Math.round(h / ab * 1000)).padStart(3, '0') : '.000';
      batterEl.textContent = `BATTER: #${idx + 1} ${name}  ¬∑  ${h}-for-${ab}  ${avg}`;
      batterEl.style.display = '';
    } else {
      batterEl.style.display = 'none';
    }
  }

  function makeDots(id, count, max, type) {
    const el = document.getElementById(id);
    el.innerHTML = '';
    for (let i = 0; i < max; i++) {
      const d = document.createElement('div');
      d.className = `dot dot-${type}` + (i < count ? ' lit' : '');
      el.appendChild(d);
    }
  }

  function renderScoreboard(n) {
    const totalInn = Math.max(9, state.inning);
    let html = '<thead><tr><th class="team-cell"></th>';
    for (let i = 1; i <= totalInn; i++) html += `<th>${i}</th>`;
    html += '<th class="runs-col">R</th></tr></thead><tbody>';

    ['away', 'home'].forEach(team => {
      const isBatting = battingTeam() === team;
      html += `<tr><td class="team-cell${isBatting ? ' batting' : ''}">${n[team]}</td>`;
      for (let i = 0; i < totalInn; i++) {
        ensureInning(i);
        const val = state.scorecard[i][team];
        const isActive = i === state.inning - 1 &&
          ((team === 'away' && state.isTop) || (team === 'home' && !state.isTop));
        const display = val !== null ? val : (isActive ? '‚Äî' : '');
        html += `<td class="${isActive ? 'active-cell' : ''}">${display}</td>`;
      }
      html += `<td class="runs-col">${totalRuns(team)}</td></tr>`;
    });

    html += '</tbody>';
    document.getElementById('scoreboard').innerHTML = html;
  }

  // ‚îÄ‚îÄ‚îÄ BATTING ORDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function currentBatterPlayer() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    if (!lineup || lineup.length === 0) return null;
    return lineup[state.batterIdx[team]];
  }

  function advanceBatter() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    if (!lineup || lineup.length === 0) return;
    state.batterIdx[team] = (state.batterIdx[team] + 1) % lineup.length;
  }

  function recordStat(result) {
    // result: 'out' | 'k' | 'bb' | 'h' | 'hr'
    const p = currentBatterPlayer();
    if (!p) return;
    if (result !== 'bb')             p.ab = (p.ab || 0) + 1;
    if (result === 'k')              p.k  = (p.k  || 0) + 1;
    if (result === 'bb')             p.bb = (p.bb || 0) + 1;
    if (result === 'h' || result === 'hr') p.h = (p.h || 0) + 1;
    if (result === 'hr')             p.hr = (p.hr || 0) + 1;
  }

  function setLastBatter(team) {
    const idx = state.batterIdx[team];
    const p   = state.lineup[team] && state.lineup[team][idx];
    state.lastBatter[team] = { idx, name: p ? (p.name || `Player ${idx + 1}`) : `#${idx + 1}` };
  }

  function creditRbi(team) {
    const lb = state.lastBatter[team];
    if (!lb) return;
    const p = state.lineup[team] && state.lineup[team][lb.idx];
    if (p) p.rbi = (p.rbi || 0) + 1;
  }

  function renderBatterCard() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    const card   = document.getElementById('batterCard');
    if (!lineup || lineup.length === 0) { card.style.display = 'none'; return; }

    card.style.display = '';
    const idx = state.batterIdx[team];
    const p   = lineup[idx];

    document.getElementById('batterOrderNum').textContent = (idx + 1) + '.';
    document.getElementById('batterName').textContent     = p.name || `Player ${idx + 1}`;
    const posBadge = document.getElementById('batterPosBadge');
    posBadge.textContent = (p.pos && p.pos !== '‚Äî') ? p.pos : '';
    posBadge.style.display = posBadge.textContent ? '' : 'none';

    const ab = p.ab||0, h = p.h||0, hr = p.hr||0, r = p.r||0, rbi = p.rbi||0, bb = p.bb||0, k = p.k||0;
    const avg = ab ? '.' + String(Math.round(h/ab*1000)).padStart(3,'0') : '.000';
    let parts = [`${h}-for-${ab}`, avg];
    if (hr)  parts.push(`${hr}HR`);
    if (r)   parts.push(`${r}R`);
    if (rbi) parts.push(`${rbi}RBI`);
    if (bb)  parts.push(`${bb}BB`);
    if (k)   parts.push(`${k}K`);
    document.getElementById('batterStats').textContent = parts.join(' ¬∑ ');
  }

  function manualPrevBatter() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    if (!lineup || lineup.length === 0) return;
    state.batterIdx[team] = (state.batterIdx[team] - 1 + lineup.length) % lineup.length;
    render();
  }

  function manualNextBatter() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    if (!lineup || lineup.length === 0) return;
    state.batterIdx[team] = (state.batterIdx[team] + 1) % lineup.length;
    render();
  }

  // ‚îÄ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function doBall() {
    state.pitches++;
    state.balls++;
    if (state.balls >= 4) {
      recordStat('bb');
      const team   = battingTeam();
      const batter = makeBatterRunner();
      const wasLoaded = state.bases[0] && state.bases[1] && state.bases[2];
      setLastBatter(team);
      advanceBatter();
      applyWalk(batter);
      if (wasLoaded) creditRbi(team); // forced run on bases-loaded walk ‚Üí RBI
      state.balls   = 0;
      state.strikes = 0;
      showToast(wasLoaded ? 'Walk ‚Äî run scores!' : 'Walk!');
    }
    render();
  }

  function doStrike() {
    state.pitches++;
    state.strikes++;
    if (state.strikes >= 3) {
      state.strikes = 0;
      state.balls   = 0;
      doOut(true, true); // pitchCounted, isK
      return;
    }
    render();
  }

  function doOut(pitchCounted = false, isK = false) {
    if (state.outs >= 3) return;
    if (!pitchCounted) state.pitches++;
    const defTeam = battingTeam() === 'away' ? 'home' : 'away';
    if (isK) {
      recordStat('k');
      setLastBatter(battingTeam());
      autoCreditCatcher(defTeam);
      creditPitcherOut(defTeam);
      advanceBatter();
      finalizeOut();
    } else {
      showOutPicker(defTeam);
    }
  }

  function finalizeOut() {
    state.outs++;
    state.balls   = 0;
    state.strikes = 0;
    render();
    if (state.outs >= 3) {
      showToast('3 Outs ‚Äî Side retired!', 2200);
      setTimeout(() => { advanceHalf(); render(); }, 1000);
    }
  }

  function creditPitcherOut(defTeam) {
    const pitcher = (state.lineup[defTeam] || []).find(p => p.pos && p.pos.toUpperCase() === 'P');
    if (pitcher) pitcher.pitchOuts = (pitcher.pitchOuts || 0) + 1;
  }

  function autoCreditCatcher(defTeam) {
    const catcher = (state.lineup[defTeam] || []).find(p => p.pos && p.pos.toUpperCase() === 'C');
    if (catcher) catcher.po = (catcher.po || 0) + 1;
  }

  function showOutPicker(defTeam) {
    const outTypes = ['Flyout', 'Groundout', 'Lineout', 'Pop-up'];
    showActionSheet('Type of Out', [
      ...outTypes.map(t => ({
        label: t, cls: 'as-btn-advance',
        fn() { showFielderPicker(t, defTeam); }
      })),
      { label: 'Other',  cls: 'as-btn-advance', fn() { applyOutFinal(); } },
      { label: 'Cancel', cls: 'as-btn-cancel',  fn() {} },
    ]);
  }

  function showFielderPicker(outType, defTeam) {
    const defLineup = state.lineup[defTeam] || [];
    const fielderBtns = defLineup.map((p, i) => ({
      label: `${p.pos || '?'}  ${p.name || 'Player ' + (i + 1)}`,
      cls: 'as-btn-advance',
      fn() { p.po = (p.po || 0) + 1; applyOutFinal(); }
    }));
    showActionSheet(`${outType} ‚Äî Who made the play?`, [
      ...fielderBtns,
      { label: 'Unknown fielder', cls: 'as-btn-cancel', fn() { applyOutFinal(); } },
    ]);
  }

  function applyOutFinal() {
    const defTeam = battingTeam() === 'away' ? 'home' : 'away';
    recordStat('out');
    setLastBatter(battingTeam());
    creditPitcherOut(defTeam);
    advanceBatter();
    finalizeOut();
  }

  function doHit() {
    // Show hit-type picker; stats + placement happen after selection
    showActionSheet('Hit Type', [
      { label: 'Single  (1B)', cls: 'as-btn-hit', fn: () => applyHit(0) },
      { label: 'Double  (2B)', cls: 'as-btn-hit', fn: () => applyHit(1) },
      { label: 'Triple  (3B)', cls: 'as-btn-hit', fn: () => applyHit(2) },
      { label: '‚≠ê Home Run',  cls: 'as-btn-hr',  fn: () => applyHit(3) },
      { label: 'Cancel',       cls: 'as-btn-cancel', fn() {} }
    ]);
  }

  function applyHit(baseIdx) {
    // baseIdx 0-2 = 1st/2nd/3rd, 3 = HR
    state.pitches++;
    recordStat(baseIdx === 3 ? 'hr' : 'h');
    const team    = battingTeam();
    const batterP = currentBatterPlayer(); // capture before advance
    setLastBatter(team);

    if (baseIdx === 3) {
      // Score all runners (each gets R; each scores an RBI for the HR hitter)
      for (let i = 2; i >= 0; i--) {
        if (state.bases[i]) { scoreRunner(i); creditRbi(team); }
      }
      // Batter scores too
      if (batterP) batterP.r = (batterP.r || 0) + 1;
      creditRbi(team); // RBI for batter's own run
      const inn = state.inning - 1;
      ensureInning(inn);
      if (state.scorecard[inn][team] === null) state.scorecard[inn][team] = 0;
      state.scorecard[inn][team]++;
      advanceBatter();
      showToast('Home Run! üéâ', 2200);
    } else {
      const runner = makeBatterRunner();
      advanceBatter();
      state.bases[baseIdx] = runner;
    }
    state.balls   = 0;
    state.strikes = 0;
    render();
  }

  function doRun() {
    const team = battingTeam();
    const idx  = state.inning - 1;
    ensureInning(idx);
    if (state.scorecard[idx][team] === null) state.scorecard[idx][team] = 0;
    state.scorecard[idx][team]++;
    render();
  }

  function undoRun() {
    const team = battingTeam();
    const idx  = state.inning - 1;
    ensureInning(idx);
    if (state.scorecard[idx][team] > 0) {
      state.scorecard[idx][team]--;
      render();
    }
  }

  function resetCount() {
    state.balls   = 0;
    state.strikes = 0;
    render();
  }

  function adjustPitches(delta) {
    state.pitches = Math.max(0, state.pitches + delta);
    render();
  }

  // ‚îÄ‚îÄ‚îÄ BASE RUNNER TRACKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function makeBatterRunner() {
    const team = battingTeam();
    const idx  = state.batterIdx[team];
    const p    = currentBatterPlayer();
    return {
      team,
      idx,
      name:     p ? (p.name || `Player ${idx + 1}`) : `#${idx + 1}`,
      orderNum: idx + 1
    };
  }

  function renderBases() {
    const rects  = ['base1',      'base2',      'base3'     ];
    const labels = ['baseLabel1', 'baseLabel2', 'baseLabel3'];
    const defLbl = ['1', '2', '3'];
    state.bases.forEach((runner, i) => {
      document.getElementById(rects[i])
        .setAttribute('fill', runner ? '#f59e0b' : '#e5e7eb');
      const lbl = document.getElementById(labels[i]);
      if (runner) {
        lbl.textContent = runner.orderNum || '?';
        lbl.setAttribute('fill', '#fff');
        lbl.setAttribute('font-weight', '700');
      } else {
        lbl.textContent = defLbl[i];
        lbl.setAttribute('fill', '#6b7280');
        lbl.setAttribute('font-weight', 'normal');
      }
    });
  }

  function scoreRunner(baseIdx) {
    const runner = state.bases[baseIdx];
    if (!runner) return;
    // Track R for the runner's player
    const rTeam   = runner.team || battingTeam();
    const rLineup = state.lineup[rTeam];
    if (rLineup && runner.idx !== undefined && rLineup[runner.idx]) {
      rLineup[runner.idx].r = (rLineup[runner.idx].r || 0) + 1;
    }
    state.bases[baseIdx] = null;
    const inn = state.inning - 1;
    ensureInning(inn);
    if (state.scorecard[inn][rTeam] === null) state.scorecard[inn][rTeam] = 0;
    state.scorecard[inn][rTeam]++;
  }

  function applyWalk(batter) {
    // Force-advance runners only when their base is occupied by a forced runner chain
    if (state.bases[0]) {
      if (state.bases[1]) {
        if (state.bases[2]) {
          scoreRunner(2); // bases loaded: runner on 3rd scores
        }
        state.bases[2] = state.bases[1];
      }
      state.bases[1] = state.bases[0];
    }
    state.bases[0] = batter;
  }

  function clickBase(baseIdx) {
    const runner = state.bases[baseIdx];
    if (!runner) return; // nothing to do on an empty base

    const baseNames = ['1st Base', '2nd Base', '3rd Base'];
    const nextNames = ['2nd Base', '3rd Base', 'Home'];
    const label     = runner.name || `#${runner.orderNum}`;

    // Build advance options for every reachable base ahead
    const advanceOptions = [];
    for (let dest = baseIdx + 1; dest <= 2; dest++) {
      const d = dest; // capture for closure
      advanceOptions.push({
        label: `‚Üí Advance to ${baseNames[d]}`,
        cls: 'as-btn-advance',
        fn() {
          state.bases[d]       = runner;
          state.bases[baseIdx] = null;
          render();
        }
      });
    }

    showActionSheet(`${label} ‚Äî ${baseNames[baseIdx]}`, [
      ...advanceOptions,
      {
        label: (() => {
          const lb = state.lastBatter[runner.team || battingTeam()];
          return `üè† Score! + RBI ‚Üí ${lb ? lb.name : '?'}`;
        })(),
        cls: 'as-btn-score',
        fn() {
          const rTeam = runner.team || battingTeam();
          const name  = runner.name || `#${runner.orderNum}`;
          scoreRunner(baseIdx);
          creditRbi(rTeam);
          showToast(`${name} scored!`);
          render();
        }
      },
      {
        label: 'üè† Score (no RBI)',
        cls: 'as-btn-advance',
        fn() {
          const name = runner.name || `#${runner.orderNum}`;
          scoreRunner(baseIdx);
          showToast(`${name} scored!`);
          render();
        }
      },
      {
        label: '‚úï Out on bases',
        cls: 'as-btn-out',
        fn() {
          const defTeam = battingTeam() === 'away' ? 'home' : 'away';
          state.bases[baseIdx] = null;
          creditPitcherOut(defTeam);
          state.outs++;
          render();
          if (state.outs >= 3) {
            showToast('3 Outs ‚Äî Side retired!', 2200);
            setTimeout(() => { advanceHalf(); render(); }, 1000);
          }
        }
      },
      { label: 'Cancel', cls: 'as-btn-cancel', fn() {} }
    ]);
  }

  // ‚îÄ‚îÄ‚îÄ ACTION SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showActionSheet(title, buttons) {
    document.getElementById('asTitle').textContent = title;
    const container = document.getElementById('asButtons');
    container.innerHTML = '';
    buttons.forEach(b => {
      const btn = document.createElement('button');
      btn.className   = 'as-btn ' + (b.cls || '');
      btn.textContent = b.label;
      btn.addEventListener('click', () => { closeActionSheet(); b.fn(); });
      container.appendChild(btn);
    });
    document.getElementById('actionSheet').style.display = 'block';
  }

  function closeActionSheet() {
    document.getElementById('actionSheet').style.display = 'none';
  }

  function advanceHalf() {
    const idx  = state.inning - 1;
    const team = battingTeam();
    ensureInning(idx);
    if (state.scorecard[idx][team] === null) state.scorecard[idx][team] = 0;

    if (state.isTop) {
      state.isTop = false;
    } else {
      state.isTop = true;
      state.inning++;
      ensureInning(state.inning - 1);
    }
    state.outs    = 0;
    state.balls   = 0;
    state.strikes = 0;
    state.pitches = 0;
    state.bases   = [null, null, null];
  }

  function nextHalf() {
    advanceHalf();
    render();
  }

  function newGame() {
    showSetup(false);
  }

  // ‚îÄ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const POSITIONS = ['‚Äî','P','C','1B','2B','3B','SS','LF','CF','RF','DH'];
  let setupLineup = { away: [], home: [] };

  function showSetup(isFirstLaunch) {
    document.getElementById('setupAwayInput').value =
      document.getElementById('awayInput').value.trim() || 'Away';
    document.getElementById('setupHomeInput').value =
      document.getElementById('homeInput').value.trim() || 'Home';
    // Seed lineup from saved state if available
    if (state.lineup) {
      setupLineup = JSON.parse(JSON.stringify(state.lineup));
    } else {
      setupLineup = { away: [], home: [] };
    }
    document.getElementById('continueBtn').style.display = isFirstLaunch ? 'none' : '';
    renderLineup('away');
    renderLineup('home');
    document.getElementById('mainScreen').style.display  = 'none';
    document.getElementById('setupScreen').style.display = 'flex';
  }

  function hideSetup() {
    document.getElementById('setupScreen').style.display = 'none';
    document.getElementById('mainScreen').style.display  = '';
  }

  function startGame() {
    saveLineupInputs('away');
    saveLineupInputs('home');
    state = freshState();
    // Deep copy lineup and add fresh stat counters
    state.lineup = {
      away: setupLineup.away.map(p => ({ name: p.name, pos: p.pos, ab:0, h:0, hr:0, r:0, rbi:0, bb:0, k:0, po:0, pitchOuts:0 })),
      home: setupLineup.home.map(p => ({ name: p.name, pos: p.pos, ab:0, h:0, hr:0, r:0, rbi:0, bb:0, k:0, po:0, pitchOuts:0 }))
    };
    document.getElementById('awayInput').value =
      document.getElementById('setupAwayInput').value.trim() || 'Away';
    document.getElementById('homeInput').value =
      document.getElementById('setupHomeInput').value.trim() || 'Home';
    hideSetup();
    render();
  }

  // ‚îÄ‚îÄ‚îÄ PLAYER ROSTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function escAttr(s) {
    return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
  }

  function saveLineupInputs(team) {
    const list = document.getElementById('lineup-' + team);
    if (!list) return;
    list.querySelectorAll('.player-row').forEach((row, i) => {
      if (!setupLineup[team][i]) return;
      setupLineup[team][i].name = row.querySelector('.player-name-input').value.trim();
      setupLineup[team][i].pos  = row.querySelector('.player-pos-select').value;
    });
  }

  function renderLineup(team) {
    const list = document.getElementById('lineup-' + team);
    if (!list) return;
    if (setupLineup[team].length === 0) {
      list.innerHTML = '<div class="player-list-empty">No players added yet</div>';
      return;
    }
    list.innerHTML = setupLineup[team].map((p, i) => {
      const opts = POSITIONS.map(pos =>
        `<option${p.pos === pos ? ' selected' : ''}>${escAttr(pos)}</option>`
      ).join('');
      return `<div class="player-row" data-idx="${i}">
        <span class="drag-handle" title="Drag to reorder">‚†ø</span>
        <span class="player-num">${i + 1}.</span>
        <input class="player-name-input" value="${escAttr(p.name)}"
               placeholder="Player ${i + 1}" maxlength="20">
        <select class="player-pos-select">${opts}</select>
        <button class="player-remove" onclick="removePlayer('${team}',${i})" aria-label="Remove">√ó</button>
      </div>`;
    }).join('');
    initDrag(team);
  }

  function addPlayer(team) {
    saveLineupInputs(team);
    if (setupLineup[team].length >= 15) return; // reasonable cap
    setupLineup[team].push({ name: '', pos: '‚Äî' });
    renderLineup(team);
    // Focus the new name field
    const list = document.getElementById('lineup-' + team);
    const inputs = list.querySelectorAll('.player-name-input');
    if (inputs.length) inputs[inputs.length - 1].focus();
  }

  function removePlayer(team, idx) {
    saveLineupInputs(team);
    setupLineup[team].splice(idx, 1);
    renderLineup(team);
  }

  // ‚îÄ‚îÄ‚îÄ DRAG-TO-REORDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function initDrag(team) {
    const list = document.getElementById('lineup-' + team);
    if (!list) return;

    list.querySelectorAll('.drag-handle').forEach((handle, idx) => {
      handle.addEventListener('mousedown',  (e) => startDrag(e, team, idx, e.clientY));
      handle.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startDrag(e, team, idx, e.touches[0].clientY);
      }, { passive: false });
    });
  }

  function startDrag(e, team, fromIdx, startClientY) {
    saveLineupInputs(team);
    const list    = document.getElementById('lineup-' + team);
    const rows    = [...list.querySelectorAll('.player-row')];
    const srcRow  = rows[fromIdx];
    const srcRect = srcRow.getBoundingClientRect();

    // Build a lightweight mirror element
    const mirror = document.createElement('div');
    mirror.className   = 'drag-mirror';
    mirror.style.width = srcRect.width + 'px';
    mirror.style.top   = srcRect.top  + 'px';
    mirror.style.left  = srcRect.left + 'px';
    mirror.innerHTML   = srcRow.innerHTML;
    document.body.appendChild(mirror);

    srcRow.classList.add('is-dragging');

    let lastClientY = startClientY;

    function getDropIdx(clientY) {
      // Returns the index (0-based) BEFORE which to insert the dragged item.
      // Iterates ALL rows (including ghost) to keep positions stable.
      const allRows = [...list.querySelectorAll('.player-row')];
      for (let i = 0; i < allRows.length; i++) {
        const r = allRows[i].getBoundingClientRect();
        if (clientY < r.top + r.height * 0.5) return i;
      }
      return allRows.length;
    }

    function onMove(clientY) {
      const dy = clientY - lastClientY;
      mirror.style.top = (parseFloat(mirror.style.top) + dy) + 'px';
      lastClientY = clientY;

      const dropIdx = getDropIdx(clientY);
      list.querySelectorAll('.player-row').forEach((r, i) => {
        r.classList.toggle('drop-above', i === dropIdx && i !== fromIdx);
      });
    }

    function onEnd(clientY) {
      mirror.remove();
      const allRows = [...list.querySelectorAll('.player-row')];
      allRows.forEach(r => r.classList.remove('is-dragging', 'drop-above'));

      let dropIdx = getDropIdx(clientY);
      // Adjust: after removing fromIdx, insertion point shifts if dropIdx > fromIdx
      if (dropIdx !== fromIdx && dropIdx !== fromIdx + 1) {
        const item = setupLineup[team].splice(fromIdx, 1)[0];
        const insertAt = dropIdx > fromIdx ? dropIdx - 1 : dropIdx;
        setupLineup[team].splice(insertAt, 0, item);
        renderLineup(team);
      }
    }

    // Mouse events (desktop)
    function onMouseMove(e) { onMove(e.clientY); }
    function onMouseUp(e)   { onEnd(e.clientY); cleanup(); }

    // Touch events (mobile)
    function onTouchMove(e) { e.preventDefault(); onMove(e.touches[0].clientY); }
    function onTouchEnd(e)  { onEnd(e.changedTouches[0].clientY); cleanup(); }

    function cleanup() {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup',   onMouseUp);
      document.removeEventListener('touchmove', onTouchMove);
      document.removeEventListener('touchend',  onTouchEnd);
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup',   onMouseUp);
    document.addEventListener('touchmove', onTouchMove, { passive: false });
    document.addEventListener('touchend',  onTouchEnd);
  }

  // ‚îÄ‚îÄ‚îÄ AUTO-SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function saveCurrentGame() {
    try {
      localStorage.setItem('bb_current', JSON.stringify({
        state,
        away: document.getElementById('awayInput').value,
        home: document.getElementById('homeInput').value
      }));
    } catch(e) {}
  }

  function loadCurrentGame() {
    try {
      const saved = JSON.parse(localStorage.getItem('bb_current'));
      if (saved && saved.state) {
        state = saved.state;
        if (!state.lineup)    state.lineup    = { away: [], home: [] };
        if (!state.batterIdx) state.batterIdx = { away: 0, home: 0 };
        // Migrate old boolean bases to runner objects
        state.bases = (state.bases || [null,null,null]).map(b => {
          if (!b || typeof b === 'boolean') return null;
          return b; // already a runner object
        });
        if (!state.lastBatter) state.lastBatter = { away: null, home: null };
        // Ensure stat fields exist on all players (backwards compat)
        ['away', 'home'].forEach(team => {
          (state.lineup[team] || []).forEach(p => {
            if (p.ab        === undefined) p.ab        = 0;
            if (p.h         === undefined) p.h         = 0;
            if (p.hr        === undefined) p.hr        = 0;
            if (p.r         === undefined) p.r         = 0;
            if (p.rbi       === undefined) p.rbi       = 0;
            if (p.bb        === undefined) p.bb        = 0;
            if (p.k         === undefined) p.k         = 0;
            if (p.po        === undefined) p.po        = 0;
            if (p.pitchOuts === undefined) p.pitchOuts = 0;
          });
        });
        // Migrate old team-level pitcherOuts to per-player pitchOuts
        if (state.pitcherOuts) {
          ['away', 'home'].forEach(team => {
            const p = (state.lineup[team] || []).find(x => x.pos && x.pos.toUpperCase() === 'P');
            if (p) p.pitchOuts = state.pitcherOuts[team] || 0;
          });
          delete state.pitcherOuts;
        }
        document.getElementById('awayInput').value = saved.away || 'Away';
        document.getElementById('homeInput').value = saved.home || 'Home';
      }
    } catch(e) {}
  }

  // ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getHistory() {
    try { return JSON.parse(localStorage.getItem('bb_history')) || []; }
    catch(e) { return []; }
  }

  function doSaveGame() {
    const n = teamNames();
    const entry = {
      id:        Date.now(),
      date:      new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}),
      away:      n.away,
      home:      n.home,
      awayRuns:  totalRuns('away'),
      homeRuns:  totalRuns('home'),
      scorecard: state.scorecard.map(inn => ({...inn})),
      lineup: {
        away: (state.lineup.away || []).map(p => ({...p})),
        home: (state.lineup.home || []).map(p => ({...p}))
      }
    };
    const history = getHistory();
    history.unshift(entry);
    try { localStorage.setItem('bb_history', JSON.stringify(history)); } catch(e) {}
    showToast('Game saved!');
    renderHistory();
    if (!historyOpen) toggleHistory();
  }

  function deleteHistoryEntry(id) {
    const history = getHistory().filter(e => e.id !== id);
    try { localStorage.setItem('bb_history', JSON.stringify(history)); } catch(e) {}
    renderHistory();
  }

  function buildHistoryStatsHTML(e) {
    const lu = e.lineup;
    if (!lu) return '<div class="history-empty" style="padding:6px 0">No player stats saved for this game.</div>';
    let html = '';
    ['away', 'home'].forEach(team => {
      const players = lu[team];
      if (!players || players.length === 0) return;
      const teamName  = team === 'away' ? e.away : e.home;
      const oppTeam   = team === 'away' ? 'home' : 'away';
      const oppPlayers = lu[oppTeam] || [];
      html += `<div>
        <div class="lineup-stats-team">${teamName}</div>
        <table class="lineup-stats-table">
          <thead><tr>
            <th>#</th><th class="lss-name">Name</th>
            <th>AB</th><th>H</th><th>AVG</th><th>HR</th><th>R</th><th>RBI</th><th>BB</th><th>K</th><th>PO</th>
          </tr></thead><tbody>`;
      players.forEach((p, i) => {
        const ab = p.ab||0, h = p.h||0, hr = p.hr||0, r = p.r||0, rbi = p.rbi||0, bb = p.bb||0, k = p.k||0, po = p.po||0;
        const avg = ab ? '.' + String(Math.round(h/ab*1000)).padStart(3,'0') : '‚Äî';
        html += `<tr>
          <td>${i+1}</td><td class="lss-name">${p.name || `Player ${i+1}`}</td>
          <td>${ab}</td><td>${h}</td><td>${avg}</td>
          <td>${hr}</td><td>${r}</td><td>${rbi}</td><td>${bb}</td><td>${k}</td><td>${po}</td>
        </tr>`;
      });
      html += `</tbody></table>`;

      const pitchers = players.filter(p => (p.pitchOuts || 0) > 0 || (p.pos && p.pos.toUpperCase() === 'P'));
      if (pitchers.length > 0) {
        const curPitcher = players.find(p => p.pos && p.pos.toUpperCase() === 'P');
        const totK  = oppPlayers.reduce((s, p) => s + (p.k  || 0), 0);
        const totBB = oppPlayers.reduce((s, p) => s + (p.bb || 0), 0);
        const totH  = oppPlayers.reduce((s, p) => s + (p.h  || 0) + (p.hr || 0), 0);
        const totR  = team === 'away' ? (e.homeRuns || 0) : (e.awayRuns || 0);
        html += `<div class="pitching-header">Pitching</div>
        <table class="lineup-stats-table">
          <thead><tr>
            <th class="lss-name">Pitcher</th>
            <th>IP</th><th>H</th><th>R</th><th>K</th><th>BB</th>
          </tr></thead><tbody>`;
        pitchers.forEach(p => {
          const outs = p.pitchOuts || 0;
          const ip   = Math.floor(outs / 3) + '.' + (outs % 3);
          const isCur = p === curPitcher;
          html += `<tr>
            <td class="lss-name">${p.name || 'Pitcher'}</td>
            <td>${ip}</td>
            <td>${isCur ? totH : '‚Äî'}</td><td>${isCur ? totR : '‚Äî'}</td>
            <td>${isCur ? totK : '‚Äî'}</td><td>${isCur ? totBB : '‚Äî'}</td>
          </tr>`;
        });
        html += `</tbody></table>`;
      }

      html += `</div>`;
    });
    return html || '<div class="history-empty" style="padding:6px 0">No player stats saved for this game.</div>';
  }

  function toggleHistoryStats(id) {
    const stats = document.getElementById('hs-' + id);
    const btn   = document.getElementById('hx-' + id);
    const isOpen = stats.style.display !== 'none';
    stats.style.display = isOpen ? 'none' : 'flex';
    btn.textContent = isOpen ? '‚ñº' : '‚ñ≤';
  }

  function renderHistory() {
    const history = getHistory();
    const list    = document.getElementById('historyList');
    if (history.length === 0) {
      list.innerHTML = '<div class="history-empty">No saved games yet.</div>';
      return;
    }
    list.innerHTML = history.map(e => {
      const awayClass = e.awayRuns > e.homeRuns ? ' winner' : '';
      const homeClass = e.homeRuns > e.awayRuns ? ' winner' : '';
      return `
        <div class="history-entry">
          <div class="history-entry-header" onclick="toggleHistoryStats(${e.id})">
            <div class="history-date">${e.date}</div>
            <div class="history-score">
              <span class="${awayClass}">${e.away} ${e.awayRuns}</span>
              <span class="sep">‚Äì</span>
              <span class="${homeClass}">${e.homeRuns} ${e.home}</span>
            </div>
            <button class="history-expand" id="hx-${e.id}">‚ñº</button>
            <button class="history-delete" onclick="event.stopPropagation(); deleteHistoryEntry(${e.id})">‚úï</button>
          </div>
          <div class="history-stats" id="hs-${e.id}" style="display:none">
            ${buildHistoryStatsHTML(e)}
          </div>
        </div>`;
    }).join('');
  }

  let historyOpen = false;

  function toggleHistory() {
    historyOpen = !historyOpen;
    const list = document.getElementById('historyList');
    list.style.display = historyOpen ? 'flex' : 'none';
    document.getElementById('historyToggle').textContent =
      historyOpen ? 'Past Games ‚ñ≤' : 'Past Games ‚ñº';
    if (historyOpen) renderHistory();
  }

  // ‚îÄ‚îÄ‚îÄ EXPORT / IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function exportHistory() {
    const history = getHistory();
    if (history.length === 0) { showToast('No saved games to export'); return; }
    const blob = new Blob(
      [JSON.stringify({bb_history: history}, null, 2)],
      {type: 'application/json'}
    );
    const url = URL.createObjectURL(blob);
    const a   = document.createElement('a');
    a.href     = url;
    a.download = 'baseball-history.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importHistory() {
    const input    = document.createElement('input');
    input.type     = 'file';
    input.accept   = '.json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const data = JSON.parse(evt.target.result);
          if (!Array.isArray(data.bb_history)) { showToast('Invalid file'); return; }
          const merged  = [...data.bb_history, ...getHistory()];
          const seen    = new Set();
          const deduped = merged.filter(e => {
            if (seen.has(e.id)) return false;
            seen.add(e.id);
            return true;
          }).sort((a, b) => b.id - a.id);
          localStorage.setItem('bb_history', JSON.stringify(deduped));
          showToast(`Imported ${data.bb_history.length} game(s)!`);
          renderHistory();
          if (!historyOpen) toggleHistory();
        } catch(err) { showToast('Could not read file'); }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  // ‚îÄ‚îÄ‚îÄ LINEUP STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let lineupStatsOpen = false;

  function toggleLineupStats() {
    lineupStatsOpen = !lineupStatsOpen;
    const el = document.getElementById('lineupStatsList');
    el.style.display = lineupStatsOpen ? 'flex' : 'none';
    document.getElementById('lineupStatsToggle').textContent =
      lineupStatsOpen ? 'Lineup Stats ‚ñ≤' : 'Lineup Stats ‚ñº';
    if (lineupStatsOpen) renderLineupStats();
  }

  function renderLineupStats() {
    const n  = teamNames();
    const el = document.getElementById('lineupStatsList');
    let html = '';

    ['away', 'home'].forEach(team => {
      const lineup = state.lineup[team];
      if (!lineup || lineup.length === 0) return;
      const curIdx  = state.batterIdx[team];
      const oppTeam = team === 'away' ? 'home' : 'away';
      const oppLineup = state.lineup[oppTeam] || [];

      html += `<div class="card" style="padding:12px 14px;">
        <div class="lineup-stats-team">${n[team]}</div>
        <table class="lineup-stats-table">
          <thead><tr>
            <th>#</th><th class="lss-name">Name</th>
            <th>AB</th><th>H</th><th>AVG</th><th>HR</th><th>R</th><th>RBI</th><th>BB</th><th>K</th><th>PO</th>
          </tr></thead><tbody>`;

      lineup.forEach((p, i) => {
        const isCur = (team === battingTeam() && i === curIdx);
        const ab  = p.ab  || 0, h   = p.h   || 0;
        const hr  = p.hr  || 0, r   = p.r   || 0;
        const rbi = p.rbi || 0, bb  = p.bb  || 0, k = p.k || 0, po = p.po || 0;
        const avg = ab ? '.' + String(Math.round(h/ab*1000)).padStart(3,'0') : '‚Äî';
        html += `<tr class="${isCur ? 'lss-current' : ''}">
          <td>${i + 1}</td>
          <td class="lss-name">${p.name || `Player ${i+1}`}</td>
          <td>${ab}</td><td>${h}</td><td>${avg}</td>
          <td>${hr}</td><td>${r}</td><td>${rbi}</td>
          <td>${bb}</td><td>${k}</td><td>${po}</td>
        </tr>`;
      });

      html += `</tbody></table>`;

      // Pitching section ‚Äî all players who pitched this game
      const pitchers = lineup.filter(p => (p.pitchOuts || 0) > 0 || (p.pos && p.pos.toUpperCase() === 'P'));
      if (pitchers.length > 0) {
        const curPitcher = lineup.find(p => p.pos && p.pos.toUpperCase() === 'P');
        const totK  = oppLineup.reduce((s, p) => s + (p.k  || 0), 0);
        const totBB = oppLineup.reduce((s, p) => s + (p.bb || 0), 0);
        const totH  = oppLineup.reduce((s, p) => s + (p.h  || 0) + (p.hr || 0), 0);
        const totR  = totalRuns(oppTeam);
        html += `<div class="pitching-header">Pitching</div>
        <table class="lineup-stats-table">
          <thead><tr>
            <th class="lss-name">Pitcher</th>
            <th>IP</th><th>H</th><th>R</th><th>K</th><th>BB</th>
          </tr></thead><tbody>`;
        pitchers.forEach(p => {
          const outs = p.pitchOuts || 0;
          const ip   = Math.floor(outs / 3) + '.' + (outs % 3);
          const isCur = p === curPitcher;
          html += `<tr>
            <td class="lss-name">${p.name || 'Pitcher'}</td>
            <td>${ip}</td>
            <td>${isCur ? totH : '‚Äî'}</td><td>${isCur ? totR : '‚Äî'}</td>
            <td>${isCur ? totK : '‚Äî'}</td><td>${isCur ? totBB : '‚Äî'}</td>
          </tr>`;
        });
        html += `</tbody></table>`;
      }

      html += `</div>`;
    });

    el.innerHTML = html || '<div class="history-empty">No lineup set.</div>';
  }

  // ‚îÄ‚îÄ‚îÄ LINEUP CHANGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openChanges() {
    renderChangesPanel();
    document.getElementById('changesOverlay').style.display = 'block';
    document.getElementById('changesSheet').style.display   = 'block';
  }

  function closeChanges() {
    document.getElementById('changesOverlay').style.display = 'none';
    document.getElementById('changesSheet').style.display   = 'none';
    render(); // Reflect any position changes in the batter card etc.
  }

  function renderChangesPanel() {
    const n    = teamNames();
    const list = document.getElementById('changesList');
    let html   = '';

    ['away', 'home'].forEach(team => {
      const lineup = state.lineup[team];
      if (!lineup || lineup.length === 0) return;
      html += `<div class="changes-team-label">${n[team]}</div>`;
      lineup.forEach((p, i) => {
        html += `
        <div class="changes-player-row" id="cpr-${team}-${i}">
          <span class="changes-order">${i + 1}</span>
          <button class="changes-pos-btn" onclick="pickPosition('${team}', ${i})">${escAttr(p.pos || '‚Äî')} ‚ñæ</button>
          <span class="changes-name">${escAttr(p.name || `Player ${i + 1}`)}</span>
          <button class="changes-sub-btn" onclick="toggleSubForm('${team}', ${i})">Sub ‚Üï</button>
        </div>
        <div class="changes-sub-form" id="csf-${team}-${i}" style="display:none">
          <input class="changes-sub-input" id="csi-${team}-${i}"
            placeholder="New player name" autocomplete="off" />
          <select class="player-pos-select" id="csp-${team}-${i}">
            ${POSITIONS.map(pos => `<option value="${pos}">${pos}</option>`).join('')}
          </select>
          <button class="changes-confirm-btn" onclick="confirmSub('${team}', ${i})">In ‚úì</button>
          <button class="changes-cancel-btn"  onclick="toggleSubForm('${team}', ${i})">‚úó</button>
        </div>`;
      });
    });

    if (!html) html = '<div style="padding:20px;text-align:center;color:#9ca3af">No lineup set up.</div>';
    list.innerHTML = html;
  }

  function pickPosition(team, idx) {
    const p = state.lineup[team] && state.lineup[team][idx];
    if (!p) return;
    const name = p.name || `Player ${idx + 1}`;
    const buttons = POSITIONS.map(pos => ({
      label: pos === p.pos ? `${pos}  ‚úì` : pos,
      cls:   pos === p.pos ? 'as-btn-hit' : 'as-btn-advance',
      fn() { p.pos = pos; renderChangesPanel(); }
    }));
    buttons.push({ label: 'Cancel', cls: 'as-btn-cancel', fn() {} });
    showActionSheet(`${name} ‚Äî Position`, buttons);
  }

  function toggleSubForm(team, idx) {
    const form = document.getElementById(`csf-${team}-${idx}`);
    const isOpen = form.style.display !== 'none';
    // Close all open forms first
    document.querySelectorAll('[id^="csf-"]').forEach(el => el.style.display = 'none');
    if (!isOpen) {
      form.style.display = 'flex';
      setTimeout(() => document.getElementById(`csi-${team}-${idx}`).focus(), 50);
    }
  }

  function confirmSub(team, idx) {
    const nameInput = document.getElementById(`csi-${team}-${idx}`);
    const posInput  = document.getElementById(`csp-${team}-${idx}`);
    const newName   = nameInput.value.trim();
    if (!newName) { nameInput.focus(); return; }
    const outName   = state.lineup[team][idx].name || `Player ${idx + 1}`;
    state.lineup[team][idx] = {
      name: newName, pos: posInput.value,
      ab: 0, h: 0, hr: 0, r: 0, rbi: 0, bb: 0, k: 0, po: 0, pitchOuts: 0
    };
    showToast(`${newName} in (replaces ${outName})`);
    renderChangesPanel();
  }

  // ‚îÄ‚îÄ‚îÄ SHARE STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function buildStatsCanvas() {
    const scale = 2;
    const W = 600;
    const PAD = 16;
    const HEADER_H = 90;
    const TEAM_BAR_H = 36;
    const COL_H = 28;
    const ROW_H = 32;
    const GAP = 16;
    const FOOTER_H = 36;

    const n = teamNames();
    const awayRuns = totalRuns('away');
    const homeRuns = totalRuns('home');

    let H = HEADER_H + PAD;
    ['away', 'home'].forEach(team => {
      const l = state.lineup[team];
      if (l && l.length) H += TEAM_BAR_H + COL_H + l.length * ROW_H + GAP;
    });
    H += FOOTER_H;

    const canvas = document.createElement('canvas');
    canvas.width = W * scale;
    canvas.height = H * scale;
    const ctx = canvas.getContext('2d');
    ctx.scale(scale, scale);

    // Background
    ctx.fillStyle = '#f1f5f9';
    ctx.fillRect(0, 0, W, H);

    // Header bar
    ctx.fillStyle = '#1e293b';
    ctx.fillRect(0, 0, W, HEADER_H);

    ctx.textBaseline = 'middle';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 26px system-ui, sans-serif';
    ctx.fillText(`${n.away}  ${awayRuns} ‚Äì ${homeRuns}  ${n.home}`, W / 2, 36);

    ctx.fillStyle = '#94a3b8';
    ctx.font = '14px system-ui, sans-serif';
    const half = state.isTop ? 'Top' : 'Bot';
    ctx.fillText(`${half} of ${state.inning}`, W / 2, 68);

    // Column definitions
    const colDefs = [
      { key: 'num',  x: PAD + 12, align: 'center', label: '#'   },
      { key: 'name', x: PAD + 28, align: 'left',   label: 'Name'},
      { key: 'ab',   x: 248,      align: 'right',  label: 'AB'  },
      { key: 'h',    x: 284,      align: 'right',  label: 'H'   },
      { key: 'avg',  x: 332,      align: 'right',  label: 'AVG' },
      { key: 'hr',   x: 368,      align: 'right',  label: 'HR'  },
      { key: 'r',    x: 400,      align: 'right',  label: 'R'   },
      { key: 'rbi',  x: 438,      align: 'right',  label: 'RBI' },
      { key: 'bb',   x: 474,      align: 'right',  label: 'BB'  },
      { key: 'k',    x: 504,      align: 'right',  label: 'K'   },
      { key: 'po',   x: 540,      align: 'right',  label: 'PO'  },
    ];
    const nameMaxW = 175;

    let y = HEADER_H + PAD;

    ['away', 'home'].forEach(team => {
      const lineup = state.lineup[team];
      if (!lineup || lineup.length === 0) return;

      // Team name bar
      ctx.fillStyle = team === 'away' ? '#dc2626' : '#2563eb';
      ctx.fillRect(PAD, y, W - PAD * 2, TEAM_BAR_H);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 14px system-ui, sans-serif';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      ctx.fillText(n[team].toUpperCase(), PAD + 12, y + TEAM_BAR_H / 2);
      y += TEAM_BAR_H;

      // Column headers
      ctx.fillStyle = '#e2e8f0';
      ctx.fillRect(PAD, y, W - PAD * 2, COL_H);
      ctx.fillStyle = '#475569';
      ctx.font = 'bold 11px system-ui, sans-serif';
      ctx.textBaseline = 'middle';
      colDefs.forEach(col => {
        ctx.textAlign = col.align;
        ctx.fillText(col.label, col.x, y + COL_H / 2);
      });
      y += COL_H;

      // Player rows
      lineup.forEach((p, i) => {
        const ab  = p.ab  || 0, h   = p.h   || 0;
        const hr  = p.hr  || 0, r   = p.r   || 0;
        const rbi = p.rbi || 0, bb  = p.bb  || 0, k = p.k || 0;
        const avg = ab ? '.' + String(Math.round(h / ab * 1000)).padStart(3, '0') : '.‚Äî';

        ctx.fillStyle = i % 2 === 0 ? '#ffffff' : '#f8fafc';
        ctx.fillRect(PAD, y, W - PAD * 2, ROW_H);

        ctx.strokeStyle = '#e2e8f0';
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.moveTo(PAD, y + ROW_H);
        ctx.lineTo(W - PAD, y + ROW_H);
        ctx.stroke();

        ctx.fillStyle = '#111827';
        ctx.font = '13px system-ui, sans-serif';
        ctx.textBaseline = 'middle';

        const rowVals = { num: String(i + 1), name: p.name || `Player ${i+1}`,
          ab: String(ab), h: String(h), avg, hr: String(hr),
          r: String(r), rbi: String(rbi), bb: String(bb), k: String(k), po: String(p.po || 0) };

        colDefs.forEach(col => {
          ctx.textAlign = col.align;
          let val = rowVals[col.key];
          if (col.key === 'name') {
            while (ctx.measureText(val).width > nameMaxW && val.length > 1) val = val.slice(0, -1);
            if (val !== rowVals.name) val += '‚Ä¶';
          }
          ctx.fillText(val, col.x, y + ROW_H / 2);
        });

        y += ROW_H;
      });

      y += GAP;
    });

    // Footer
    ctx.fillStyle = '#94a3b8';
    ctx.font = '12px system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Baseball Scorer', W / 2, y + FOOTER_H / 2);

    return canvas;
  }

  function shareStats() {
    const n = teamNames();
    const title = `${n.away} vs ${n.home} ‚Äì Stats`;
    const canvas = buildStatsCanvas();
    canvas.toBlob(async blob => {
      const file = new File([blob], 'baseball-stats.png', { type: 'image/png' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title });
          return;
        } catch (e) {
          if (e.name === 'AbortError') return;
        }
      }
      // Fallback: download the PNG
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'baseball-stats.png';
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }, 'image/png');
  }

  // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('awayInput').addEventListener('input', render);
  document.getElementById('homeInput').addEventListener('input', render);

  loadCurrentGame();
  if (!localStorage.getItem('bb_current')) {
    showSetup(true);
  } else {
    render();
  }
</script>
</body>
</html>
