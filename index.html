<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Baseball Scorer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #f1f5f9;
      color: #111827;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      max-width: 480px;
      margin: 0 auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
      padding: 16px;
    }

    /* ── HEADER CARD ── */
    .score-header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }

    .team-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .team-input {
      background: transparent;
      border: none;
      border-bottom: 1.5px solid #e5e7eb;
      color: #374151;
      font-size: 0.78rem;
      font-family: inherit;
      font-weight: 700;
      text-transform: uppercase;
      text-align: center;
      padding: 2px 4px;
      width: 100%;
      letter-spacing: 0.8px;
      transition: border-color 0.2s;
    }

    .team-input:focus {
      outline: none;
      border-bottom-color: #dc2626;
    }

    .team-run-score {
      font-size: 2.6rem;
      font-weight: 800;
      color: #111827;
      line-height: 1;
    }

    .score-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding-top: 18px;
    }

    .score-dash {
      font-size: 1.4rem;
      color: #d1d5db;
      font-weight: 300;
    }

    /* ── INNING BADGE ── */
    .inning-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .half-arrows {
      display: flex;
      flex-direction: column;
      gap: 3px;
      align-items: center;
    }

    .arrow-up {
      width: 0; height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 8px solid #e5e7eb;
    }
    .arrow-up.active  { border-bottom-color: #dc2626; }

    .arrow-down {
      width: 0; height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid #e5e7eb;
    }
    .arrow-down.active { border-top-color: #dc2626; }

    .inning-text {
      font-size: 0.75rem;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ── SCOREBOARD ── */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th, td {
      padding: 5px 3px;
      text-align: center;
      min-width: 22px;
    }

    thead th {
      color: #9ca3af;
      font-weight: 500;
      padding-bottom: 6px;
      border-bottom: 1px solid #f3f4f6;
    }

    tbody tr + tr { border-top: 1px solid #f9fafb; }

    .team-cell {
      text-align: left !important;
      padding-left: 2px !important;
      font-weight: 700;
      color: #374151;
      white-space: nowrap;
      font-size: 0.75rem;
      min-width: 48px;
    }

    .batting { color: #dc2626 !important; }

    .active-cell {
      background: #fef2f2;
      color: #dc2626;
      font-weight: 700;
      border-radius: 4px;
    }

    .runs-col {
      font-weight: 800 !important;
      color: #111827 !important;
      font-size: 0.85rem;
      border-left: 1px solid #f3f4f6;
    }

    /* ── FIELD CARD: diamond + count side by side ── */
    .field-card {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      align-items: center;
    }

    .diamond-wrap {
      display: flex;
      justify-content: center;
    }

    /* ── COUNT + PITCH ── */
    .count-section {
      display: flex;
      flex-direction: column;
      gap: 9px;
    }

    .count-row-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .count-label {
      font-size: 0.65rem;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      min-width: 48px;
    }

    .dots { display: flex; gap: 6px; }

    .dot {
      width: 13px;
      height: 13px;
      border-radius: 50%;
      border: 2px solid;
    }

    .dot-ball            { border-color: #bbf7d0; }
    .dot-ball.lit        { background: #16a34a; border-color: #16a34a; }
    .dot-strike          { border-color: #fecaca; }
    .dot-strike.lit      { background: #dc2626; border-color: #dc2626; }
    .dot-out             { border-color: #fecaca; }
    .dot-out.lit         { background: #dc2626; border-color: #dc2626; }

    .count-divider {
      border: none;
      border-top: 1px solid #f3f4f6;
      margin: 2px 0;
    }

    .pitch-row-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pitch-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #pitchCount {
      font-size: 1.3rem;
      font-weight: 800;
      color: #111827;
      min-width: 2.2ch;
      text-align: center;
    }

    .pitch-adj {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      color: #6b7280;
      font-size: 1rem;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-family: inherit;
      line-height: 1;
    }

    .pitch-adj:active { background: #f3f4f6; }

    /* ── ACTION BUTTONS ── */
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .btn {
      padding: 19px 10px;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 700;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      color: #fff;
    }

    .btn:active { filter: brightness(0.88); }

    .btn-ball   { background: #16a34a; }
    .btn-strike { background: #dc2626; }
    .btn-out    { background: #7c3aed; }
    .btn-run    { background: #2563eb; }
    .btn-hit    { background: #f59e0b; }

    /* ── SECONDARY ── */
    .secondary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .btn-sm {
      padding: 11px 4px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.72rem;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
    }

    .btn-sm:active { background: #f9fafb; }

    /* ── BOTTOM ROW ── */
    .bottom-row {
      display: flex;
      gap: 8px;
    }

    .btn-save-game {
      flex: 1;
      padding: 12px;
      background: #fff;
      border: 1.5px solid #16a34a;
      border-radius: 10px;
      color: #16a34a;
      font-family: inherit;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-save-game:active { background: #f0fdf4; }

    .btn-new-game {
      flex: 1;
      padding: 12px;
      background: #fff;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      color: #9ca3af;
      font-family: inherit;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-new-game:active { background: #f9fafb; }

    /* ── HISTORY ── */
    .history-header {
      display: flex;
      gap: 6px;
    }

    .history-toggle-btn {
      flex: 1;
      padding: 11px 12px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      text-align: left;
    }

    .history-toggle-btn:active { background: #f9fafb; }

    .btn-transfer {
      padding: 11px 12px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-transfer:active { background: #f9fafb; }

    #historyList {
      display: none;
      flex-direction: column;
      gap: 6px;
      padding-bottom: 12px;
    }

    .history-entry {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: #fff;
      border: 1px solid #f3f4f6;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .history-date {
      font-size: 0.68rem;
      color: #9ca3af;
      white-space: nowrap;
      min-width: 64px;
    }

    .history-score {
      flex: 1;
      font-size: 0.88rem;
      color: #374151;
      text-align: center;
      font-weight: 500;
    }

    .history-score .winner {
      color: #dc2626;
      font-weight: 700;
    }

    .history-score .sep { color: #d1d5db; margin: 0 5px; }

    .history-delete {
      background: transparent;
      border: none;
      color: #d1d5db;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 2px 4px;
    }

    .history-delete:active { color: #9ca3af; }

    .history-empty {
      text-align: center;
      color: #9ca3af;
      font-size: 0.85rem;
      padding: 16px;
      background: #fff;
      border: 1px solid #f3f4f6;
      border-radius: 12px;
    }

    /* ── BATTER CARD ── */
    .batter-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .batter-info {
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .batter-label {
      font-size: 0.58rem;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }

    .batter-main-line {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 5px;
    }

    .batter-order-num {
      font-size: 0.78rem;
      font-weight: 600;
      color: #9ca3af;
    }

    .batter-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: #111827;
    }

    .batter-pos-badge {
      font-size: 0.7rem;
      font-weight: 600;
      color: #6b7280;
      background: #f3f4f6;
      padding: 1px 5px;
      border-radius: 4px;
    }

    .batter-stats-line {
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .batter-nav {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      color: #9ca3af;
      font-size: 0.75rem;
      width: 34px;
      height: 34px;
      cursor: pointer;
      font-family: inherit;
      flex-shrink: 0;
      line-height: 1;
    }

    .batter-nav:active { background: #f3f4f6; }

    /* ── LINEUP STATS ── */
    .lineup-stats-team {
      font-size: 0.7rem;
      font-weight: 700;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 8px;
    }

    .lineup-stats-table {
      width: 100%;
      font-size: 0.76rem;
      border-collapse: collapse;
    }

    .lineup-stats-table th {
      color: #9ca3af;
      font-weight: 500;
      text-align: center;
      padding: 4px 3px 6px;
      border-bottom: 1px solid #f3f4f6;
    }

    .lineup-stats-table th.lss-name,
    .lineup-stats-table td.lss-name {
      text-align: left;
      padding-left: 2px;
    }

    .lineup-stats-table td {
      text-align: center;
      padding: 5px 3px;
    }

    .lineup-stats-table tr + tr { border-top: 1px solid #f9fafb; }

    .lss-current td {
      color: #dc2626;
      font-weight: 700;
    }

    /* ── SETUP SCREEN ── */
    #mainScreen {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #setupScreen {
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    .setup-title {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 800;
      color: #111827;
      padding: 8px 0 2px;
      letter-spacing: -0.3px;
    }

    .setup-subtitle {
      text-align: center;
      font-size: 0.76rem;
      color: #9ca3af;
      margin-top: 2px;
    }

    .setup-section-label {
      font-size: 0.68rem;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 8px;
    }

    .setup-team-input {
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.95rem;
      font-family: inherit;
      font-weight: 600;
      color: #111827;
      background: #f9fafb;
      outline: none;
      width: 100%;
      transition: border-color 0.15s;
    }

    .setup-team-input:focus {
      border-color: #dc2626;
      background: #fff;
    }

    .btn-start-game {
      width: 100%;
      padding: 18px;
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 14px;
      font-size: 1rem;
      font-weight: 700;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    }

    .btn-start-game:active { filter: brightness(0.88); }

    .btn-continue-game {
      width: 100%;
      padding: 13px;
      background: #fff;
      border: 1.5px solid #e5e7eb;
      border-radius: 12px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-continue-game:active { background: #f9fafb; }

    /* ── PLAYER LIST ── */
    .setup-lineup-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0 6px;
    }

    .btn-add-player {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 500;
      padding: 5px 10px;
      cursor: pointer;
    }

    .btn-add-player:active { background: #f3f4f6; }

    .player-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .player-list-empty {
      text-align: center;
      color: #9ca3af;
      font-size: 0.8rem;
      padding: 8px 0 2px;
    }

    .player-row {
      display: flex;
      align-items: center;
      gap: 7px;
      background: #f9fafb;
      border: 1px solid #f3f4f6;
      border-radius: 10px;
      padding: 8px 10px;
    }

    .player-num {
      font-size: 0.72rem;
      color: #9ca3af;
      min-width: 14px;
      text-align: right;
      flex-shrink: 0;
    }

    .player-name-input {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      font-family: inherit;
      font-size: 0.88rem;
      font-weight: 500;
      color: #111827;
      min-width: 0;
    }

    .player-pos-select {
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #fff;
      color: #374151;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 5px;
      cursor: pointer;
      outline: none;
      flex-shrink: 0;
    }

    .player-remove {
      background: transparent;
      border: none;
      color: #d1d5db;
      font-size: 1rem;
      cursor: pointer;
      padding: 0 2px;
      line-height: 1;
      flex-shrink: 0;
    }

    .player-remove:active { color: #9ca3af; }

    .drag-handle {
      color: #d1d5db;
      font-size: 1.1rem;
      cursor: grab;
      padding: 0 2px;
      line-height: 1;
      flex-shrink: 0;
      touch-action: none;
      user-select: none;
    }

    .drag-handle:active { cursor: grabbing; }

    .player-row.is-dragging { opacity: 0.25; }

    .player-row.drop-above { border-top: 2px solid #dc2626; }

    .drag-mirror {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.9;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      padding: 8px 10px;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    /* ── TOAST ── */
    #toast {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.88rem;
      z-index: 999;
      display: none;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<div id="toast"></div>

<!-- Pre-game setup screen -->
<div id="setupScreen">
  <div>
    <div class="setup-title">⚾ Baseball Scorer</div>
    <div class="setup-subtitle">Set up your game</div>
  </div>

  <div class="card">
    <div class="setup-section-label">Away Team</div>
    <input class="setup-team-input" id="setupAwayInput" value="Away" maxlength="10"
           autocomplete="off" autocorrect="off" spellcheck="false" placeholder="Away team name">
    <div class="setup-lineup-bar">
      <span class="setup-section-label" style="margin-bottom:0">Lineup</span>
      <button class="btn-add-player" onclick="addPlayer('away')">+ Add Player</button>
    </div>
    <div class="player-list" id="lineup-away"></div>
  </div>

  <div class="card">
    <div class="setup-section-label">Home Team</div>
    <input class="setup-team-input" id="setupHomeInput" value="Home" maxlength="10"
           autocomplete="off" autocorrect="off" spellcheck="false" placeholder="Home team name">
    <div class="setup-lineup-bar">
      <span class="setup-section-label" style="margin-bottom:0">Lineup</span>
      <button class="btn-add-player" onclick="addPlayer('home')">+ Add Player</button>
    </div>
    <div class="player-list" id="lineup-home"></div>
  </div>

  <button class="btn-start-game" onclick="startGame()">⚾ Play Ball</button>
  <button class="btn-continue-game" id="continueBtn" onclick="hideSetup()">← Continue Current Game</button>
</div>

<!-- Main scoring screen -->
<div id="mainScreen">

<!-- Header card: live score + team names + inning -->
<div class="card">
  <div class="score-header">
    <div class="team-block">
      <input class="team-input" id="awayInput" value="Away" maxlength="10"
             autocomplete="off" autocorrect="off" spellcheck="false" placeholder="AWAY">
      <div class="team-run-score" id="awayScore">0</div>
    </div>
    <div class="score-center">
      <span class="score-dash">—</span>
    </div>
    <div class="team-block">
      <input class="team-input" id="homeInput" value="Home" maxlength="10"
             autocomplete="off" autocorrect="off" spellcheck="false" placeholder="HOME">
      <div class="team-run-score" id="homeScore">0</div>
    </div>
  </div>
  <div class="inning-badge">
    <div class="half-arrows">
      <div class="arrow-up"   id="arrowUp"></div>
      <div class="arrow-down" id="arrowDown"></div>
    </div>
    <div class="inning-text" id="inningText">TOP — 1st INNING</div>
  </div>
</div>

<!-- Scoreboard -->
<div class="card" style="padding: 12px 14px;">
  <table id="scoreboard"></table>
</div>

<!-- Field card: diamond + count + pitch -->
<div class="card">
  <div class="field-card">
    <div class="diamond-wrap">
      <svg width="138" height="138" viewBox="0 0 200 200">
        <!-- Dirt -->
        <polygon points="100,18 182,100 100,182 18,100"
                 fill="#fef9ef" stroke="#e8dcc8" stroke-width="1"/>
        <!-- Grass -->
        <polygon points="100,34 166,100 100,166 34,100"
                 fill="#f0f7e8" stroke="none"/>
        <!-- Base paths -->
        <line x1="100" y1="182" x2="182" y2="100" stroke="#ddd0b0" stroke-width="1.5"/>
        <line x1="182" y1="100" x2="100" y2="18"  stroke="#ddd0b0" stroke-width="1.5"/>
        <line x1="100" y1="18"  x2="18"  y2="100" stroke="#ddd0b0" stroke-width="1.5"/>
        <line x1="18"  y1="100" x2="100" y2="182" stroke="#ddd0b0" stroke-width="1.5"/>
        <!-- Home plate -->
        <polygon points="100,190 109,181 109,175 91,175 91,181" fill="#9ca3af"/>
        <!-- 2nd base -->
        <rect id="base2" x="87" y="7" width="26" height="22" rx="3"
              fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"
              style="cursor:pointer" onclick="toggleBase(1)"/>
        <text x="100" y="21" fill="#6b7280" font-size="11"
              text-anchor="middle" dominant-baseline="middle" pointer-events="none">2</text>
        <!-- 1st base -->
        <rect id="base1" x="163" y="88" width="26" height="24" rx="3"
              fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"
              style="cursor:pointer" onclick="toggleBase(0)"/>
        <text x="176" y="101" fill="#6b7280" font-size="11"
              text-anchor="middle" dominant-baseline="middle" pointer-events="none">1</text>
        <!-- 3rd base -->
        <rect id="base3" x="11" y="88" width="26" height="24" rx="3"
              fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"
              style="cursor:pointer" onclick="toggleBase(2)"/>
        <text x="24" y="101" fill="#6b7280" font-size="11"
              text-anchor="middle" dominant-baseline="middle" pointer-events="none">3</text>
      </svg>
    </div>

    <div class="count-section">
      <div class="count-row-item">
        <span class="count-label">Balls</span>
        <div class="dots" id="ballDots"></div>
      </div>
      <div class="count-row-item">
        <span class="count-label">Strikes</span>
        <div class="dots" id="strikeDots"></div>
      </div>
      <div class="count-row-item">
        <span class="count-label">Outs</span>
        <div class="dots" id="outDots"></div>
      </div>
      <hr class="count-divider">
      <div class="pitch-row-inner">
        <span class="count-label">Pitches</span>
        <div class="pitch-controls">
          <button class="pitch-adj" onclick="adjustPitches(-1)">−</button>
          <span id="pitchCount">0</span>
          <button class="pitch-adj" onclick="adjustPitches(1)">+</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Current batter -->
<div class="card" id="batterCard" style="display:none; padding:12px 16px;">
  <div class="batter-row">
    <button class="batter-nav" onclick="manualPrevBatter()">◀</button>
    <div class="batter-info">
      <span class="batter-label">At Bat</span>
      <div class="batter-main-line">
        <span class="batter-order-num" id="batterOrderNum"></span>
        <span class="batter-name" id="batterName"></span>
        <span class="batter-pos-badge" id="batterPosBadge"></span>
      </div>
      <span class="batter-stats-line" id="batterStats"></span>
    </div>
    <button class="batter-nav" onclick="manualNextBatter()">▶</button>
  </div>
</div>

<!-- Main action buttons -->
<div class="actions">
  <button class="btn btn-ball"   onclick="doBall()">Ball</button>
  <button class="btn btn-strike" onclick="doStrike()">Strike</button>
  <button class="btn btn-out"    onclick="doOut()">Out</button>
  <button class="btn btn-hit"    onclick="doHit()">Hit</button>
</div>

<!-- Secondary controls -->
<div class="secondary">
  <button class="btn-sm" onclick="doRun()">+ Run</button>
  <button class="btn-sm" onclick="undoRun()">− Run</button>
  <button class="btn-sm" onclick="resetCount()">Reset Count</button>
  <button class="btn-sm" onclick="nextHalf()">Next Half ▶</button>
</div>

<!-- Save / New game -->
<div class="bottom-row">
  <button class="btn-save-game" onclick="doSaveGame()">Save Game</button>
  <button class="btn-new-game"  onclick="newGame()">New Game</button>
</div>

<!-- History -->
<div class="history-header">
  <button class="history-toggle-btn" id="historyToggle" onclick="toggleHistory()">Past Games ▼</button>
  <button class="btn-transfer" onclick="exportHistory()">Export ↓</button>
  <button class="btn-transfer" onclick="importHistory()">Import ↑</button>
</div>
<div id="historyList"></div>

<!-- Lineup Stats -->
<div class="history-header">
  <button class="history-toggle-btn" id="lineupStatsToggle" onclick="toggleLineupStats()">Lineup Stats ▼</button>
</div>
<div id="lineupStatsList" style="display:none; flex-direction:column; gap:6px;"></div>

</div><!-- /mainScreen -->

<script>
  // ─── STATE ─────────────────────────────────────────────────────────────────
  let state = freshState();

  function freshState() {
    return {
      inning:    1,
      isTop:     true,
      balls:     0,
      strikes:   0,
      outs:      0,
      bases:     [false, false, false],
      pitches:   0,
      scorecard: Array.from({length: 9}, () => ({away: null, home: null})),
      lineup:    { away: [], home: [] },
      batterIdx: { away: 0, home: 0 }
    };
  }

  // ─── HELPERS ───────────────────────────────────────────────────────────────
  function ordinal(n) {
    const s = ['th','st','nd','rd'];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
  }

  function teamNames() {
    return {
      away: document.getElementById('awayInput').value.trim() || 'Away',
      home: document.getElementById('homeInput').value.trim() || 'Home'
    };
  }

  function battingTeam() {
    return state.isTop ? 'away' : 'home';
  }

  function ensureInning(idx) {
    while (state.scorecard.length <= idx) {
      state.scorecard.push({away: null, home: null});
    }
  }

  function totalRuns(team) {
    return state.scorecard.reduce((sum, inn) => sum + (inn[team] || 0), 0);
  }

  // ─── TOAST ─────────────────────────────────────────────────────────────────
  let toastTimer = null;

  function showToast(msg, ms = 1800) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.display = 'block';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { el.style.display = 'none'; }, ms);
  }

  // ─── RENDER ────────────────────────────────────────────────────────────────
  function render() {
    saveCurrentGame();
    const n = teamNames();

    // Live score
    document.getElementById('awayScore').textContent = totalRuns('away');
    document.getElementById('homeScore').textContent = totalRuns('home');

    // Inning text + arrows
    document.getElementById('inningText').textContent =
      `${state.isTop ? 'TOP' : 'BOT'} — ${ordinal(state.inning)} INNING`;
    document.getElementById('arrowUp').className =
      'arrow-up'   + (state.isTop ? ' active' : '');
    document.getElementById('arrowDown').className =
      'arrow-down' + (state.isTop ? '' : ' active');

    // Scoreboard
    renderScoreboard(n);

    // Bases
    const baseIds = ['base1', 'base2', 'base3'];
    state.bases.forEach((on, i) => {
      document.getElementById(baseIds[i]).setAttribute('fill', on ? '#f59e0b' : '#e5e7eb');
    });

    // Pitch count
    document.getElementById('pitchCount').textContent = state.pitches;

    // Count dots
    makeDots('ballDots',   state.balls,   3, 'ball');
    makeDots('strikeDots', state.strikes, 2, 'strike');
    makeDots('outDots',    state.outs,    2, 'out');

    // Current batter
    renderBatterCard();

    // Refresh lineup stats if open
    if (lineupStatsOpen) renderLineupStats();
  }

  function makeDots(id, count, max, type) {
    const el = document.getElementById(id);
    el.innerHTML = '';
    for (let i = 0; i < max; i++) {
      const d = document.createElement('div');
      d.className = `dot dot-${type}` + (i < count ? ' lit' : '');
      el.appendChild(d);
    }
  }

  function renderScoreboard(n) {
    const totalInn = Math.max(9, state.inning);
    let html = '<thead><tr><th class="team-cell"></th>';
    for (let i = 1; i <= totalInn; i++) html += `<th>${i}</th>`;
    html += '<th class="runs-col">R</th></tr></thead><tbody>';

    ['away', 'home'].forEach(team => {
      const isBatting = battingTeam() === team;
      html += `<tr><td class="team-cell${isBatting ? ' batting' : ''}">${n[team]}</td>`;
      for (let i = 0; i < totalInn; i++) {
        ensureInning(i);
        const val = state.scorecard[i][team];
        const isActive = i === state.inning - 1 &&
          ((team === 'away' && state.isTop) || (team === 'home' && !state.isTop));
        const display = val !== null ? val : (isActive ? '—' : '');
        html += `<td class="${isActive ? 'active-cell' : ''}">${display}</td>`;
      }
      html += `<td class="runs-col">${totalRuns(team)}</td></tr>`;
    });

    html += '</tbody>';
    document.getElementById('scoreboard').innerHTML = html;
  }

  // ─── BATTING ORDER ─────────────────────────────────────────────────────────
  function currentBatterPlayer() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    if (!lineup || lineup.length === 0) return null;
    return lineup[state.batterIdx[team]];
  }

  function advanceBatter() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    if (!lineup || lineup.length === 0) return;
    state.batterIdx[team] = (state.batterIdx[team] + 1) % lineup.length;
  }

  function recordStat(result) {
    // result: 'out' | 'k' | 'bb' | 'h'
    const team = battingTeam();
    const p    = currentBatterPlayer();
    if (!p) return;
    if (result !== 'bb') p.ab = (p.ab || 0) + 1; // BB doesn't count as AB
    if (result === 'k')  p.k  = (p.k  || 0) + 1;
    if (result === 'bb') p.bb = (p.bb || 0) + 1;
    if (result === 'h')  p.h  = (p.h  || 0) + 1;
  }

  function renderBatterCard() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    const card   = document.getElementById('batterCard');
    if (!lineup || lineup.length === 0) { card.style.display = 'none'; return; }

    card.style.display = '';
    const idx = state.batterIdx[team];
    const p   = lineup[idx];

    document.getElementById('batterOrderNum').textContent = (idx + 1) + '.';
    document.getElementById('batterName').textContent     = p.name || `Player ${idx + 1}`;
    const posBadge = document.getElementById('batterPosBadge');
    posBadge.textContent = (p.pos && p.pos !== '—') ? p.pos : '';
    posBadge.style.display = posBadge.textContent ? '' : 'none';

    const ab = p.ab || 0, h = p.h || 0, bb = p.bb || 0, k = p.k || 0;
    let s = `${h}-for-${ab}`;
    if (bb) s += ` · ${bb}BB`;
    if (k)  s += ` · ${k}K`;
    document.getElementById('batterStats').textContent = s;
  }

  function manualPrevBatter() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    if (!lineup || lineup.length === 0) return;
    state.batterIdx[team] = (state.batterIdx[team] - 1 + lineup.length) % lineup.length;
    render();
  }

  function manualNextBatter() {
    const team   = battingTeam();
    const lineup = state.lineup[team];
    if (!lineup || lineup.length === 0) return;
    state.batterIdx[team] = (state.batterIdx[team] + 1) % lineup.length;
    render();
  }

  // ─── ACTIONS ───────────────────────────────────────────────────────────────
  function doBall() {
    state.pitches++;
    state.balls++;
    if (state.balls >= 4) {
      recordStat('bb');
      advanceBatter();
      state.balls   = 0;
      state.strikes = 0;
      showToast('Walk!');
    }
    render();
  }

  function doStrike() {
    state.pitches++;
    state.strikes++;
    if (state.strikes >= 3) {
      state.strikes = 0;
      state.balls   = 0;
      doOut(true, true); // pitchCounted, isK
      return;
    }
    render();
  }

  function doOut(pitchCounted = false, isK = false) {
    if (state.outs >= 3) return;
    if (!pitchCounted) state.pitches++;
    recordStat(isK ? 'k' : 'out');
    advanceBatter();
    state.outs++;
    state.balls   = 0;
    state.strikes = 0;
    render();
    if (state.outs >= 3) {
      showToast('3 Outs — Side retired!', 2200);
      setTimeout(() => { advanceHalf(); render(); }, 1000);
    }
  }

  function doHit() {
    recordStat('h');
    advanceBatter();
    state.balls   = 0;
    state.strikes = 0;
    render();
  }

  function doRun() {
    const team = battingTeam();
    const idx  = state.inning - 1;
    ensureInning(idx);
    if (state.scorecard[idx][team] === null) state.scorecard[idx][team] = 0;
    state.scorecard[idx][team]++;
    render();
  }

  function undoRun() {
    const team = battingTeam();
    const idx  = state.inning - 1;
    ensureInning(idx);
    if (state.scorecard[idx][team] > 0) {
      state.scorecard[idx][team]--;
      render();
    }
  }

  function resetCount() {
    state.balls   = 0;
    state.strikes = 0;
    render();
  }

  function adjustPitches(delta) {
    state.pitches = Math.max(0, state.pitches + delta);
    render();
  }

  function toggleBase(i) {
    state.bases[i] = !state.bases[i];
    render();
  }

  function advanceHalf() {
    const idx  = state.inning - 1;
    const team = battingTeam();
    ensureInning(idx);
    if (state.scorecard[idx][team] === null) state.scorecard[idx][team] = 0;

    if (state.isTop) {
      state.isTop = false;
    } else {
      state.isTop = true;
      state.inning++;
      ensureInning(state.inning - 1);
    }
    state.outs    = 0;
    state.balls   = 0;
    state.strikes = 0;
    state.pitches = 0;
    state.bases   = [false, false, false];
  }

  function nextHalf() {
    advanceHalf();
    render();
  }

  function newGame() {
    showSetup(false);
  }

  // ─── SETUP SCREEN ──────────────────────────────────────────────────────────
  const POSITIONS = ['—','P','C','1B','2B','3B','SS','LF','CF','RF','DH'];
  let setupLineup = { away: [], home: [] };

  function showSetup(isFirstLaunch) {
    document.getElementById('setupAwayInput').value =
      document.getElementById('awayInput').value.trim() || 'Away';
    document.getElementById('setupHomeInput').value =
      document.getElementById('homeInput').value.trim() || 'Home';
    // Seed lineup from saved state if available
    if (state.lineup) {
      setupLineup = JSON.parse(JSON.stringify(state.lineup));
    } else {
      setupLineup = { away: [], home: [] };
    }
    document.getElementById('continueBtn').style.display = isFirstLaunch ? 'none' : '';
    renderLineup('away');
    renderLineup('home');
    document.getElementById('mainScreen').style.display  = 'none';
    document.getElementById('setupScreen').style.display = 'flex';
  }

  function hideSetup() {
    document.getElementById('setupScreen').style.display = 'none';
    document.getElementById('mainScreen').style.display  = '';
  }

  function startGame() {
    saveLineupInputs('away');
    saveLineupInputs('home');
    state = freshState();
    // Deep copy lineup and add fresh stat counters
    state.lineup = {
      away: setupLineup.away.map(p => ({ name: p.name, pos: p.pos, ab:0, h:0, bb:0, k:0 })),
      home: setupLineup.home.map(p => ({ name: p.name, pos: p.pos, ab:0, h:0, bb:0, k:0 }))
    };
    document.getElementById('awayInput').value =
      document.getElementById('setupAwayInput').value.trim() || 'Away';
    document.getElementById('homeInput').value =
      document.getElementById('setupHomeInput').value.trim() || 'Home';
    hideSetup();
    render();
  }

  // ─── PLAYER ROSTER ─────────────────────────────────────────────────────────
  function escAttr(s) {
    return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
  }

  function saveLineupInputs(team) {
    const list = document.getElementById('lineup-' + team);
    if (!list) return;
    list.querySelectorAll('.player-row').forEach((row, i) => {
      if (!setupLineup[team][i]) return;
      setupLineup[team][i].name = row.querySelector('.player-name-input').value.trim();
      setupLineup[team][i].pos  = row.querySelector('.player-pos-select').value;
    });
  }

  function renderLineup(team) {
    const list = document.getElementById('lineup-' + team);
    if (!list) return;
    if (setupLineup[team].length === 0) {
      list.innerHTML = '<div class="player-list-empty">No players added yet</div>';
      return;
    }
    list.innerHTML = setupLineup[team].map((p, i) => {
      const opts = POSITIONS.map(pos =>
        `<option${p.pos === pos ? ' selected' : ''}>${escAttr(pos)}</option>`
      ).join('');
      return `<div class="player-row" data-idx="${i}">
        <span class="drag-handle" title="Drag to reorder">⠿</span>
        <span class="player-num">${i + 1}.</span>
        <input class="player-name-input" value="${escAttr(p.name)}"
               placeholder="Player ${i + 1}" maxlength="20">
        <select class="player-pos-select">${opts}</select>
        <button class="player-remove" onclick="removePlayer('${team}',${i})" aria-label="Remove">×</button>
      </div>`;
    }).join('');
    initDrag(team);
  }

  function addPlayer(team) {
    saveLineupInputs(team);
    if (setupLineup[team].length >= 15) return; // reasonable cap
    setupLineup[team].push({ name: '', pos: '—' });
    renderLineup(team);
    // Focus the new name field
    const list = document.getElementById('lineup-' + team);
    const inputs = list.querySelectorAll('.player-name-input');
    if (inputs.length) inputs[inputs.length - 1].focus();
  }

  function removePlayer(team, idx) {
    saveLineupInputs(team);
    setupLineup[team].splice(idx, 1);
    renderLineup(team);
  }

  // ─── DRAG-TO-REORDER ───────────────────────────────────────────────────────
  function initDrag(team) {
    const list = document.getElementById('lineup-' + team);
    if (!list) return;

    list.querySelectorAll('.drag-handle').forEach((handle, idx) => {
      handle.addEventListener('mousedown',  (e) => startDrag(e, team, idx, e.clientY));
      handle.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startDrag(e, team, idx, e.touches[0].clientY);
      }, { passive: false });
    });
  }

  function startDrag(e, team, fromIdx, startClientY) {
    saveLineupInputs(team);
    const list    = document.getElementById('lineup-' + team);
    const rows    = [...list.querySelectorAll('.player-row')];
    const srcRow  = rows[fromIdx];
    const srcRect = srcRow.getBoundingClientRect();

    // Build a lightweight mirror element
    const mirror = document.createElement('div');
    mirror.className   = 'drag-mirror';
    mirror.style.width = srcRect.width + 'px';
    mirror.style.top   = srcRect.top  + 'px';
    mirror.style.left  = srcRect.left + 'px';
    mirror.innerHTML   = srcRow.innerHTML;
    document.body.appendChild(mirror);

    srcRow.classList.add('is-dragging');

    let lastClientY = startClientY;

    function getDropIdx(clientY) {
      // Returns the index (0-based) BEFORE which to insert the dragged item.
      // Iterates ALL rows (including ghost) to keep positions stable.
      const allRows = [...list.querySelectorAll('.player-row')];
      for (let i = 0; i < allRows.length; i++) {
        const r = allRows[i].getBoundingClientRect();
        if (clientY < r.top + r.height * 0.5) return i;
      }
      return allRows.length;
    }

    function onMove(clientY) {
      const dy = clientY - lastClientY;
      mirror.style.top = (parseFloat(mirror.style.top) + dy) + 'px';
      lastClientY = clientY;

      const dropIdx = getDropIdx(clientY);
      list.querySelectorAll('.player-row').forEach((r, i) => {
        r.classList.toggle('drop-above', i === dropIdx && i !== fromIdx);
      });
    }

    function onEnd(clientY) {
      mirror.remove();
      const allRows = [...list.querySelectorAll('.player-row')];
      allRows.forEach(r => r.classList.remove('is-dragging', 'drop-above'));

      let dropIdx = getDropIdx(clientY);
      // Adjust: after removing fromIdx, insertion point shifts if dropIdx > fromIdx
      if (dropIdx !== fromIdx && dropIdx !== fromIdx + 1) {
        const item = setupLineup[team].splice(fromIdx, 1)[0];
        const insertAt = dropIdx > fromIdx ? dropIdx - 1 : dropIdx;
        setupLineup[team].splice(insertAt, 0, item);
        renderLineup(team);
      }
    }

    // Mouse events (desktop)
    function onMouseMove(e) { onMove(e.clientY); }
    function onMouseUp(e)   { onEnd(e.clientY); cleanup(); }

    // Touch events (mobile)
    function onTouchMove(e) { e.preventDefault(); onMove(e.touches[0].clientY); }
    function onTouchEnd(e)  { onEnd(e.changedTouches[0].clientY); cleanup(); }

    function cleanup() {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup',   onMouseUp);
      document.removeEventListener('touchmove', onTouchMove);
      document.removeEventListener('touchend',  onTouchEnd);
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup',   onMouseUp);
    document.addEventListener('touchmove', onTouchMove, { passive: false });
    document.addEventListener('touchend',  onTouchEnd);
  }

  // ─── AUTO-SAVE ─────────────────────────────────────────────────────────────
  function saveCurrentGame() {
    try {
      localStorage.setItem('bb_current', JSON.stringify({
        state,
        away: document.getElementById('awayInput').value,
        home: document.getElementById('homeInput').value
      }));
    } catch(e) {}
  }

  function loadCurrentGame() {
    try {
      const saved = JSON.parse(localStorage.getItem('bb_current'));
      if (saved && saved.state) {
        state = saved.state;
        if (!state.lineup)    state.lineup    = { away: [], home: [] };
        if (!state.batterIdx) state.batterIdx = { away: 0, home: 0 };
        // Ensure stat fields exist on all players (backwards compat)
        ['away', 'home'].forEach(team => {
          (state.lineup[team] || []).forEach(p => {
            if (p.ab === undefined) p.ab = 0;
            if (p.h  === undefined) p.h  = 0;
            if (p.bb === undefined) p.bb = 0;
            if (p.k  === undefined) p.k  = 0;
          });
        });
        document.getElementById('awayInput').value = saved.away || 'Away';
        document.getElementById('homeInput').value = saved.home || 'Home';
      }
    } catch(e) {}
  }

  // ─── HISTORY ───────────────────────────────────────────────────────────────
  function getHistory() {
    try { return JSON.parse(localStorage.getItem('bb_history')) || []; }
    catch(e) { return []; }
  }

  function doSaveGame() {
    const n = teamNames();
    const entry = {
      id:        Date.now(),
      date:      new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}),
      away:      n.away,
      home:      n.home,
      awayRuns:  totalRuns('away'),
      homeRuns:  totalRuns('home'),
      scorecard: state.scorecard.map(inn => ({...inn}))
    };
    const history = getHistory();
    history.unshift(entry);
    try { localStorage.setItem('bb_history', JSON.stringify(history)); } catch(e) {}
    showToast('Game saved!');
    renderHistory();
    if (!historyOpen) toggleHistory();
  }

  function deleteHistoryEntry(id) {
    const history = getHistory().filter(e => e.id !== id);
    try { localStorage.setItem('bb_history', JSON.stringify(history)); } catch(e) {}
    renderHistory();
  }

  function renderHistory() {
    const history = getHistory();
    const list    = document.getElementById('historyList');
    if (history.length === 0) {
      list.innerHTML = '<div class="history-empty">No saved games yet.</div>';
      return;
    }
    list.innerHTML = history.map(e => {
      const awayClass = e.awayRuns > e.homeRuns ? ' winner' : '';
      const homeClass = e.homeRuns > e.awayRuns ? ' winner' : '';
      return `
        <div class="history-entry">
          <div class="history-date">${e.date}</div>
          <div class="history-score">
            <span class="${awayClass}">${e.away} ${e.awayRuns}</span>
            <span class="sep">–</span>
            <span class="${homeClass}">${e.homeRuns} ${e.home}</span>
          </div>
          <button class="history-delete" onclick="deleteHistoryEntry(${e.id})">✕</button>
        </div>`;
    }).join('');
  }

  let historyOpen = false;

  function toggleHistory() {
    historyOpen = !historyOpen;
    const list = document.getElementById('historyList');
    list.style.display = historyOpen ? 'flex' : 'none';
    document.getElementById('historyToggle').textContent =
      historyOpen ? 'Past Games ▲' : 'Past Games ▼';
    if (historyOpen) renderHistory();
  }

  // ─── EXPORT / IMPORT ───────────────────────────────────────────────────────
  function exportHistory() {
    const history = getHistory();
    if (history.length === 0) { showToast('No saved games to export'); return; }
    const blob = new Blob(
      [JSON.stringify({bb_history: history}, null, 2)],
      {type: 'application/json'}
    );
    const url = URL.createObjectURL(blob);
    const a   = document.createElement('a');
    a.href     = url;
    a.download = 'baseball-history.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importHistory() {
    const input    = document.createElement('input');
    input.type     = 'file';
    input.accept   = '.json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const data = JSON.parse(evt.target.result);
          if (!Array.isArray(data.bb_history)) { showToast('Invalid file'); return; }
          const merged  = [...data.bb_history, ...getHistory()];
          const seen    = new Set();
          const deduped = merged.filter(e => {
            if (seen.has(e.id)) return false;
            seen.add(e.id);
            return true;
          }).sort((a, b) => b.id - a.id);
          localStorage.setItem('bb_history', JSON.stringify(deduped));
          showToast(`Imported ${data.bb_history.length} game(s)!`);
          renderHistory();
          if (!historyOpen) toggleHistory();
        } catch(err) { showToast('Could not read file'); }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  // ─── LINEUP STATS ──────────────────────────────────────────────────────────
  let lineupStatsOpen = false;

  function toggleLineupStats() {
    lineupStatsOpen = !lineupStatsOpen;
    const el = document.getElementById('lineupStatsList');
    el.style.display = lineupStatsOpen ? 'flex' : 'none';
    document.getElementById('lineupStatsToggle').textContent =
      lineupStatsOpen ? 'Lineup Stats ▲' : 'Lineup Stats ▼';
    if (lineupStatsOpen) renderLineupStats();
  }

  function renderLineupStats() {
    const n  = teamNames();
    const el = document.getElementById('lineupStatsList');
    let html = '';

    ['away', 'home'].forEach(team => {
      const lineup = state.lineup[team];
      if (!lineup || lineup.length === 0) return;
      const curIdx = state.batterIdx[team];

      html += `<div class="card" style="padding:12px 14px;">
        <div class="lineup-stats-team">${n[team]}</div>
        <table class="lineup-stats-table">
          <thead><tr>
            <th>#</th><th class="lss-name">Name</th><th>Pos</th>
            <th>AB</th><th>H</th><th>BB</th><th>K</th>
          </tr></thead><tbody>`;

      lineup.forEach((p, i) => {
        const isCur = (team === battingTeam() && i === curIdx);
        html += `<tr class="${isCur ? 'lss-current' : ''}">
          <td>${i + 1}</td>
          <td class="lss-name">${p.name || `Player ${i+1}`}</td>
          <td>${(p.pos && p.pos !== '—') ? p.pos : '—'}</td>
          <td>${p.ab || 0}</td><td>${p.h || 0}</td>
          <td>${p.bb || 0}</td><td>${p.k || 0}</td>
        </tr>`;
      });

      html += `</tbody></table></div>`;
    });

    el.innerHTML = html || '<div class="history-empty">No lineup set.</div>';
  }

  // ─── INIT ──────────────────────────────────────────────────────────────────
  document.getElementById('awayInput').addEventListener('input', render);
  document.getElementById('homeInput').addEventListener('input', render);

  loadCurrentGame();
  if (!localStorage.getItem('bb_current')) {
    showSetup(true);
  } else {
    render();
  }
</script>
</body>
</html>
